<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>SQLite</title>
<!-- 2014-01-30 Thu 13:54 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="wei.sun" />
<link rel="stylesheet" type="text/css" href="/stylesheets/main.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">SQLite</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. SQLite</a>
<ul>
<li><a href="#sec-1-1">1.1. Android API</a></li>
<li><a href="#sec-1-2">1.2. C API</a></li>
<li><a href="#sec-1-3">1.3. SQLite</a></li>
<li><a href="#sec-1-4">1.4. Benchmark</a></li>
<li><a href="#sec-1-5">1.5. Other</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> SQLite</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Android API</h3>
<div class="outline-text-3" id="text-1-1">
<pre class="example">
                                 +----------------+
                                 | SQLiteDatabase |                         +------------------+
                                 +-+----------+---+                  +-----&gt;+ SQLiteConnection-+-&lt;---+
                                   |          |                      |      +------------------+     |
                                   |          v                      |      +------------------+     |
     +--------------------+--------+     +----+------------------+   +-----&gt;+ SQLiteConnection |     |
     |                    |              | SQLiteConnection Pool-+---+      +-----+-----+------+     |
     v thread_1           v thread_2     +-------+---------------+                |     ^            |
+----+----------+    +----+----------+           ^                                |     |            |
| SQLiteSession |    | SQLiteSession-+-----------+      +----------------------+  |     |            |
+----+-------+--+    +------+--+-----+           |      |PreparedStatementCache+&lt;-+     |            |
     |       |              |                    |      +----------------------+        |            |
     |       +--------------+--------------------+                                      |            |
     |                      |                                                           |            |
     |                      +-----------------------------------------------------------+            |
     |                                                                                               |
     +-----------------------------------------------------------------------------------------------+
</pre>
</div>

<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1"><span class="section-number-4">1.1.1</span> SQLiteDatabase &amp; SQLiteDatabase (c)</h4>
<div class="outline-text-4" id="text-1-1-1">
</div><div id="outline-container-sec-1-1-1-1" class="outline-5">
<h5 id="sec-1-1-1-1"><span class="section-number-5">1.1.1.1</span> addCustomFunction</h5>
</div>
</div>

<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2"><span class="section-number-4">1.1.2</span> SQLiteStatement (c)</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
Note that `SQLiteStatement' has nothing to do with the native
`prepared statement', it nothing but a `helper class' to store:
</p>
<ul class="org-ul">
<li>sql string
</li>
<li>bind args
</li>
<li>db connection (session)
</li>
</ul>

<p>
In fact, there is ONE class named `PreparedStatement', defined in the
`SQLiteConnection', which corresponds to the `native prepared
statement', and also there is `PreparedStatementCache' in
SQLiteConnection to avoid redundant statement preparations. So, cache
`SQLiteStatement' manually may make no sense? so I really doubt that
`android providers should use DatabaseUtils.InsertHelper to cache
SQLiteStatement', as mentioned in:
</p>

<p>
<a href="http://www.outofwhatbox.com/blog/2010/12/android-using-databaseutils-inserthelper-for-faster-insertions-into-sqlite-database/#comment-2685">android-using-databaseutils-inserthelper-for-faster-insertions-into-sqlite-database/</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-1-3" class="outline-4">
<h4 id="sec-1-1-3"><span class="section-number-4">1.1.3</span> SQLiteSession</h4>
</div>
<div id="outline-container-sec-1-1-4" class="outline-4">
<h4 id="sec-1-1-4"><span class="section-number-4">1.1.4</span> SQLiteConnection &amp; SQLiteConnectionPool</h4>
<div class="outline-text-4" id="text-1-1-4">
</div><div id="outline-container-sec-1-1-4-1" class="outline-5">
<h5 id="sec-1-1-4-1"><span class="section-number-5">1.1.4.1</span> Yield</h5>
</div>
<div id="outline-container-sec-1-1-4-2" class="outline-5">
<h5 id="sec-1-1-4-2"><span class="section-number-5">1.1.4.2</span> WAL (Write-ahead Logging)</h5>
<div class="outline-text-5" id="text-1-1-4-2">
<p>
<a href="http://sqlite.org/wal.html">http://sqlite.org/wal.html</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-1-5" class="outline-4">
<h4 id="sec-1-1-5"><span class="section-number-4">1.1.5</span> SQLiteProgram &amp; SQLiteQuery &amp; SQLiteQueryBuilder</h4>
</div>
<div id="outline-container-sec-1-1-6" class="outline-4">
<h4 id="sec-1-1-6"><span class="section-number-4">1.1.6</span> Cursor &amp; CursorWindow</h4>
<div class="outline-text-4" id="text-1-1-6">
</div><div id="outline-container-sec-1-1-6-1" class="outline-5">
<h5 id="sec-1-1-6-1"><span class="section-number-5">1.1.6.1</span> SQLiteCursorDriver</h5>
</div>
<div id="outline-container-sec-1-1-6-2" class="outline-5">
<h5 id="sec-1-1-6-2"><span class="section-number-5">1.1.6.2</span> CursorFactory</h5>
</div>
<div id="outline-container-sec-1-1-6-3" class="outline-5">
<h5 id="sec-1-1-6-3"><span class="section-number-5">1.1.6.3</span> Cursor</h5>
<div class="outline-text-5" id="text-1-1-6-3">
</div><ol class="org-ol"><li>Cursor Class Hierarchy<br  /><div class="outline-text-6" id="text-1-1-6-3-1">
<pre class="example">
                          -+----------+
                           | Cursor/I |
                          -+----+-----+
                                |
                                |
                     -+---------+-----------+
                      | CrossProcessCursor/I|
                     -+----+----+-----------+
                                |
                                |
                      -+-----+--+---------+
                       | AbstractCursor/A |
                      -+--------+---------+
                                |
            -+------------------+---------------+----------------------+
             |                                  |                      |
-+-----------+--------------+          -+-------+------+       -+------+------+
 | AbstractWindowedCursor/A |           | MatrixCursor |        | MergeCursor |
-+-----------+--------------+          -+--------------+       -+-------------+
             |
            -+----------------------------+
             |                            |
    -+-------+------+      -+-------------+-------------+
     | SqliteCursor |       | BulkCursorToCursorAdaptor |
    -+--------------+      -+---------------------------+
</pre>
</div>
<ol class="org-ol"><li>Cursor across process<br  /><div class="outline-text-7" id="text-1-1-6-3-1-1">
<p>
When Cursor in the remote process need to be returned to local process, the
remote Cursor will be wrapped into a binder object named
`CursorToBulkCursorAdaptor`, which is not a cursor, but implements methods like
`onMove`, `getWindow`, etc.
</p>

<p>
When the local process received the `CursorToBulkCursorAdaptor` binder, it
again will be wrapped into a local cursor object named
`BulkCursorToCursorAdaptor`, which is a `AbstractWindowedCursor`
</p>


<pre class="example">
            -+------------------------+
             | AbstractWindowedCursor |
            -+----------+-------------+
                        |
                        |
          -+------------+--------------+
           | BulkCursorToCursorAdaptor |
          -+------------+--------------+
                        |
                        |
               -+-------+------+        local process (e.g. app)
--------------- |  BulkCursor  | -------------------
               -+-------+------+        remote process (e.g. provider)
                        |
                        |
          -+------------+--------------+
           | CursorToBulkCursorAdaptor |
          -+------------+--------------+
                        |
                        |
                 -+----------+
                  |  Cursor  |
                 -+----------+
</pre>
</div>
</li></ol>
</li>
<li>Code Snippet<br  /><ol class="org-ol"><li>moveToFirst<br  /><div class="outline-text-7" id="text-1-1-6-3-2-1">
<div class="org-src-container">

<pre class="src src-text">AbstractCursor.moveToFirst
  AbstractCursor.moveToPosition(0)
    ret=SqliteCursor.onMove(origPos,0)
      if mWindow==null || newPosition &lt; mWindow.getStartPosition()
         || newPosition &gt;= mWindow.getStartPosition()+ mWindow.getNumRows():
         SqliteCursor.fillWindow(newPosition)
           mWindow.setStartPosition(newPosition)
           getQuery().fillWindow(newPosition)
             SQLiteQuery.nativeFillWindow(nHandle, nStatement, window.mWindowPtr,
                        startPos, mOffsetIndex);
               // Bind the offset parameter, telling the program which row to start with
               sqlite3_bind_int(statement, offsetParam, startPos);
               while (!windowFull):
                 sqlite3_step(statement);
                 window-&gt;allocRow();
                 for (int i = 0; i &lt; numColumns; i++):
                   int type = sqlite3_column_type(statement, i);
                   if (type == SQLITE_TEXT):
                     const char* text = reinterpret_cast&lt;const char*&gt;(sqlite3_column_text(statement, i));
                     window-&gt;putString(addedRows, i, text, sizeIncludingNull);
                   elif: // other type
                 // end for
               // end while
               sqlite3_reset(statement);
    if ret:
      mPos=newPos;
</pre>
</div>
</div>
</li>

<li>getString<br  /><div class="outline-text-7" id="text-1-1-6-3-2-2">
<div class="org-src-container">

<pre class="src src-text">Cursor.getString(pos)
  AbstractWindowedCursor.getString(pos)
    mWindow.getString(pos)
      nativeGetString(pos)
</pre>
</div>
</div>
</li></ol>
</li>

<li>SQLiteCursor<br  /><div class="outline-text-6" id="text-1-1-6-3-3">
<ul class="org-ul">
<li>SQLiteCursorDriver
used to create the SqliteCursor
</li>
<li>SQLiteQuery
used to invoke `nativefillWindow`
</li>
</ul>
</div>
</li>

<li>To summarize<br  /><div class="outline-text-6" id="text-1-1-6-3-4">
<ol class="org-ol">
<li>Cursor by itself is not `CrossProcess`, but with the help of `BulkCursor`
,`BulkCursorToCursorAdaptor` and `CursorToBulkCursorAdaptor`, Cursor can be
`CrossProcess`
</li>
<li>The most important methods of the `Cursor` object:
<ol class="org-ol">
<li>fillWindow

<p>
`nativefillWindow` will execute the real query, and fill the result set to
the `CursorWindow`.  ps. `getCount` will invoke `fillWindow` implicitly.
</p>
</li>

<li>onMove

<p>
`fillWindow` is during `onMove`, e.g. `moveToFirst`, `moveToNext`, &#x2026;
</p>
</li>
</ol>
</li>
</ol>
</div>
</li></ol>
</div>
<div id="outline-container-sec-1-1-6-4" class="outline-5">
<h5 id="sec-1-1-6-4"><span class="section-number-5">1.1.6.4</span> CursorWindow</h5>
<div class="outline-text-5" id="text-1-1-6-4">
<p>
`CursorWindow` is parcelable, it represents a `window` of sqlite query
data. The underlying data of a Java CursorWindow object is managed by
CursorWindow c++ object, in both of the server side and the client
side.
</p>
</div>

<ol class="org-ol"><li>init<br  /><div class="outline-text-6" id="text-1-1-6-4-1">
<div class="org-src-container">

<pre class="src src-text">onMove
  fillWindow
    clearOrCreateWindow
      mWindow = new CursorWindow(name);
        // sCursorWindowSize specifies the window size in kb, e.g. 2048 Kb
        mWindowPtr = CursorWindow.nativeCreate(name, sCursorWindowSize);
</pre>
</div>
</div>
</li>
<li>how CursorWindow is passed across process<br  /><div class="outline-text-6" id="text-1-1-6-4-2">
<p>
Because `CursorWindow` is only a parcelable (not a binder), so the remote
`CursorWindow` need to be fetched by the local process again and again,
e.g. during local `onMove`
</p>

<div class="org-src-container">

<pre class="src src-text">BulkCursorToCursorAdaptor.onMove
  if (mWindow == null
      || newPosition &lt; mWindow.getStartPosition()
      || newPosition &gt;= mWindow.getStartPosition() + mWindow.getNumRows()):
    setWindow(mBulkCursor.getWindow(newPosition));
      // remote process
      CursorToBulkCursorAdaptor.getWindow(newPosition)
        mCursor.moveToPosition(startPos)
        return mCursor.getWindow()
          // SQLiteCursor
          mCursor.fillWindow(position, window);  
            mQuery.fillWindow(position,window);
              getSession().executeForCursorWindow();
                SQLiteConnection.nativeExecuteForCursorWindow(start, requiredRow)  
                // native
                  while (window not full):
                    sqlite3_step(stmt);
                    copy_row(window)
                  sqlite3_reset(stmt)
                nativeFinalizeStatement(stmt);
</pre>
</div>
</div>

<ol class="org-ol"><li>关于 CursorWindow 的一个 bug (or feature)<br  /><div class="outline-text-7" id="text-1-1-6-4-2-1">
<p>
每次 onMove (包括 cursor.moveToPosition 等) 都会导致底层的 statement 实
际上会重新查询 &#x2026;. 所以这种设计会导致这个 bug (or feature?)
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">query</span>() {
    <span style="color: #b58900;">SQLiteDatabase</span> <span style="color: #268bd2;">db</span> = SQLiteDatabase.openDatabase(<span style="color: #2aa198;">"/storage/sdcard1/test.db"</span>, <span style="color: #2aa198;">null</span>,<span style="color: #2aa198;">SQLiteDatabase</span>.OPEN_READWRITE, <span style="color: #2aa198;">null</span>);
    <span style="color: #b58900;">Cursor</span> <span style="color: #268bd2;">cursor</span>=db.query(<span style="color: #2aa198;">"test"</span>, <span style="color: #859900;">new</span> <span style="color: #b58900;">String</span>[] {<span style="color: #2aa198;">"name"</span>,<span style="color: #2aa198;">"count"</span>}, <span style="color: #2aa198;">null</span>,<span style="color: #2aa198;">null</span>, <span style="color: #2aa198;">null</span>, <span style="color: #2aa198;">null</span>, <span style="color: #2aa198;">"name"</span>);
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"query:get count:"</span>+cursor.getCount());
    cursor.moveToFirst();
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"moveToFirst: data:"</span>+cursor.getString(0));
    cursor.moveToLast();
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"moved to last"</span>);
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"insert a row"</span>);

    db.beginTransaction();
    db.execSQL(<span style="color: #2aa198;">"INSERT INTO test VALUES (\"aaa\",1)"</span>);
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"done"</span>);
    db.setTransactionSuccessful();
    db.endTransaction();

    cursor.moveToFirst();
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"moveToFirst again: data:"</span>+cursor.getString(0));
    cursor.close();
}
</pre>
</div>

<p>
当原有数据足够多时 (保证 moveToLast 会调用 fillWindow 替换掉当前
window), 对同一 cursor 调用两次 moveToFirst 查询的结果不同 &#x2026;. 若要避
免这个情况, 要么底层的 cursor window 足够大, 能容纳所有的内容, 要么
cursor 查询返回后不 finalized statement, 这样可以保证 read transaction
持有 shared lock, 那么其他 write transaction 会因为无法获得 exclusive
lock 而无法修改数据库.
</p>
</div>
</li></ol>
</li>
<li>CursorWindow and `ashmem'<br  /><div class="outline-text-6" id="text-1-1-6-4-3">
<p>
The underlying data of a Java CursorWindow is managed by CursorWindow
c++ object, and is stored using `ashmem'
</p>

<div class="org-src-container">

<pre class="src src-c++">  <span style="color: #b58900;">status_t</span> <span style="color: #2aa198;">CursorWindow</span>::<span style="color: #268bd2;">writeToParcel</span>(<span style="color: #b58900;">Parcel</span>* <span style="color: #268bd2;">parcel</span>) {
      <span style="color: #b58900;">status_t</span> <span style="color: #268bd2;">status</span> = parcel-&gt;writeString8(mName);
      <span style="color: #859900;">if</span> (<span style="color: #dc322f;">!</span>status) {
          status = parcel-&gt;writeDupFileDescriptor(mAshmemFd);
      }
      <span style="color: #859900;">return</span> status;
  }

<span style="color: #b58900;">status_t</span> <span style="color: #2aa198;">CursorWindow</span>::<span style="color: #268bd2;">createFromParcel</span>(<span style="color: #b58900;">Parcel</span>* <span style="color: #268bd2;">parcel</span>, <span style="color: #b58900;">CursorWindow</span>** <span style="color: #268bd2;">outCursorWindow</span>) {
    <span style="color: #b58900;">String8</span> <span style="color: #268bd2;">name</span> = parcel-&gt;readString8();

    <span style="color: #b58900;">status_t</span> <span style="color: #268bd2;">result</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">ashmemFd</span> = parcel-&gt;readFileDescriptor();
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">...</span>
}
</pre>
</div>

<p>
So, CursorWindow parceling is quite efficient using `ashmem', and
that why CursorWindow could deliver more than 1MB data using binder.
</p>

<pre class="example">
~@sunway-x230&gt; adb shell procmem 642|grep "CursorWindow"
     0K       0K       0K       0K       0K       0K       0K       0K  /dev/ashmem/CursorWindow:
     0K       0K       0K       0K       0K       0K       0K       0K  /dev/ashmem/CursorWindow:
     4K       4K       2K       0K       0K       4K       0K       0K  /dev/ashmem/CursorWindow:
     0K       0K       0K       0K       0K       0K       0K       0K  /dev/ashmem/CursorWindow:
     4K       4K       4K       4K       0K       0K       4K       0K  /dev/ashmem/CursorWindow:
</pre>
</div>
</li></ol>
</div>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> C API</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> sqlite3<sub>open</sub></h4>
</div>
<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> sqltie3<sub>prepare</sub><sub>v2</sub></h4>
</div>
<div id="outline-container-sec-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><span class="section-number-4">1.2.3</span> sqlite3<sub>step</sub></h4>
</div>
<div id="outline-container-sec-1-2-4" class="outline-4">
<h4 id="sec-1-2-4"><span class="section-number-4">1.2.4</span> sqlite3<sub>reset</sub></h4>
</div>
<div id="outline-container-sec-1-2-5" class="outline-4">
<h4 id="sec-1-2-5"><span class="section-number-4">1.2.5</span> sqlite3<sub>bind</sub></h4>
</div>
<div id="outline-container-sec-1-2-6" class="outline-4">
<h4 id="sec-1-2-6"><span class="section-number-4">1.2.6</span> sqlite3<sub>exec</sub></h4>
</div>
<div id="outline-container-sec-1-2-7" class="outline-4">
<h4 id="sec-1-2-7"><span class="section-number-4">1.2.7</span> sqlite3<sub>get</sub><sub>tables</sub></h4>
</div>
<div id="outline-container-sec-1-2-8" class="outline-4">
<h4 id="sec-1-2-8"><span class="section-number-4">1.2.8</span> sqlite3<sub>mprintf</sub></h4>
</div>
<div id="outline-container-sec-1-2-9" class="outline-4">
<h4 id="sec-1-2-9"><span class="section-number-4">1.2.9</span> sqlite3<sub>commit</sub><sub>hook</sub></h4>
</div>
<div id="outline-container-sec-1-2-10" class="outline-4">
<h4 id="sec-1-2-10"><span class="section-number-4">1.2.10</span> sqlite3<sub>rollback</sub><sub>hook</sub></h4>
</div>
<div id="outline-container-sec-1-2-11" class="outline-4">
<h4 id="sec-1-2-11"><span class="section-number-4">1.2.11</span> sqlite3<sub>busy</sub><sub>handler</sub></h4>
</div>
<div id="outline-container-sec-1-2-12" class="outline-4">
<h4 id="sec-1-2-12"><span class="section-number-4">1.2.12</span> sqlite3<sub>busy</sub><sub>timeout</sub></h4>
</div>
<div id="outline-container-sec-1-2-13" class="outline-4">
<h4 id="sec-1-2-13"><span class="section-number-4">1.2.13</span> sqlite3<sub>trace</sub></h4>
</div>
<div id="outline-container-sec-1-2-14" class="outline-4">
<h4 id="sec-1-2-14"><span class="section-number-4">1.2.14</span> sqlite3<sub>finalize</sub></h4>
<div class="outline-text-4" id="text-1-2-14">
<p>
在 auto-commit 模式下, sqlite3<sub>finalize</sub> 相当于 commit 的作用:
</p>
<ul class="org-ul">
<li>释放锁
</li>
<li>sync 日志与数据库
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2-15" class="outline-4">
<h4 id="sec-1-2-15"><span class="section-number-4">1.2.15</span> extension api</h4>
<div class="outline-text-4" id="text-1-2-15">
</div><div id="outline-container-sec-1-2-15-1" class="outline-5">
<h5 id="sec-1-2-15-1"><span class="section-number-5">1.2.15.1</span> user defined functions</h5>
<div class="outline-text-5" id="text-1-2-15-1">
<p>
sqlite3<sub>create</sub><sub>funtion</sub>
</p>
</div>
</div>

<div id="outline-container-sec-1-2-15-2" class="outline-5">
<h5 id="sec-1-2-15-2"><span class="section-number-5">1.2.15.2</span> user defined aggregates</h5>
</div>
<div id="outline-container-sec-1-2-15-3" class="outline-5">
<h5 id="sec-1-2-15-3"><span class="section-number-5">1.2.15.3</span> user define collations</h5>
<div class="outline-text-5" id="text-1-2-15-3">
<p>
sqlite3<sub>create</sub><sub>collation</sub>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-2-16" class="outline-4">
<h4 id="sec-1-2-16"><span class="section-number-4">1.2.16</span> sample code</h4>
<div class="outline-text-4" id="text-1-2-16">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #cb4b16;">#include</span> <span style="color: #2aa198;">&lt;sqlite3.h&gt;</span>
<span style="color: #cb4b16;">#include</span> <span style="color: #2aa198;">&lt;pthread.h&gt;</span>

<span style="color: #b58900;">void</span> <span style="color: #268bd2;">query</span>(<span style="color: #b58900;">sqlite3</span> * <span style="color: #268bd2;">db</span>) {
    <span style="color: #b58900;">sqlite3_stmt</span> *<span style="color: #268bd2;">stmt</span>;
    <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> * <span style="color: #268bd2;">tail</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">rc</span>=sqlite3_prepare_v2(db,<span style="color: #2aa198;">"select * from test"</span>, -1, &amp;stmt, &amp;tail);
    <span style="color: #859900;">if</span> (rc!=SQLITE_OK) {
        fprintf(<span style="color: #2aa198;">"error prepare stmt: %s"</span>, sqlite3_errmsg(db));
        exit (1);
    }
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">count</span>=0;
    rc=sqlite3_step(stmt);
    <span style="color: #859900;">while</span> (rc==SQLITE_ROW) {
        count++;
        rc=sqlite3_step(stmt);
    }
    sqlite3_finalize(stmt);
    printf(<span style="color: #2aa198;">"query returns %d\n"</span>,count);
}

<span style="color: #b58900;">void</span> * <span style="color: #268bd2;">fun</span>(<span style="color: #b58900;">void</span> * <span style="color: #268bd2;">args</span>) {
    query((<span style="color: #b58900;">sqlite3</span> *)args);
}


<span style="color: #b58900;">int</span> <span style="color: #268bd2;">main</span>(<span style="color: #b58900;">int</span> <span style="color: #268bd2;">argc</span>, <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">argv</span>[]) {
    sqlite3_config(SQLITE_CONFIG_SERIALIZED);
    <span style="color: #586e75; font-style: italic;">/* </span><span style="color: #586e75; font-style: italic;">sqlite3_enable_shared_cache(SQLITE_OPEN_SHAREDCACHE); </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #b58900;">sqlite3</span> *<span style="color: #268bd2;">db</span>;
    <span style="color: #b58900;">sqlite3</span> *<span style="color: #268bd2;">db2</span>;

    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">rc</span>=sqlite3_open_v2(<span style="color: #2aa198;">"/home/sunway/test.db"</span>, &amp;db, SQLITE_OPEN_READWRITE, 0);

    <span style="color: #859900;">if</span> (rc) {
        printf(<span style="color: #2aa198;">"can't open db: %s"</span>,sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }

    <span style="color: #b58900;">pthread_t</span> <span style="color: #268bd2;">tid</span>;
    pthread_create(&amp;tid, <span style="color: #2aa198;">NULL</span>, fun, db);

    query(db);
    pthread_join(tid, <span style="color: #2aa198;">NULL</span>);
    <span style="color: #586e75; font-style: italic;">/* </span><span style="color: #586e75; font-style: italic;">char * sql="insert into test values (\"test\",1)"; </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #586e75; font-style: italic;">/* </span><span style="color: #586e75; font-style: italic;">char * zerr; </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #586e75; font-style: italic;">/* </span><span style="color: #586e75; font-style: italic;">rc=sqlite3_exec(db,sql,0,0,&amp;zerr); </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #586e75; font-style: italic;">/* </span><span style="color: #586e75; font-style: italic;">if (rc!=SQLITE_OK) { </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #586e75; font-style: italic;">/*  </span><span style="color: #586e75; font-style: italic;">printf("error when insert: %s", zerr); </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #586e75; font-style: italic;">/*  </span><span style="color: #586e75; font-style: italic;">exit (1); </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #586e75; font-style: italic;">/* </span><span style="color: #586e75; font-style: italic;">} </span><span style="color: #586e75; font-style: italic;">*/</span>
    <span style="color: #859900;">return</span> 0;
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> SQLite</h3>
<div class="outline-text-3" id="text-1-3">
</div><div id="outline-container-sec-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> sqlite3<sub>analyzer</sub></h4>
</div>
<div id="outline-container-sec-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><span class="section-number-4">1.3.2</span> sqlite command</h4>
<div class="outline-text-4" id="text-1-3-2">
</div><div id="outline-container-sec-1-3-2-1" class="outline-5">
<h5 id="sec-1-3-2-1"><span class="section-number-5">1.3.2.1</span> .output</h5>
</div>
<div id="outline-container-sec-1-3-2-2" class="outline-5">
<h5 id="sec-1-3-2-2"><span class="section-number-5">1.3.2.2</span> .mode</h5>
<div class="outline-text-5" id="text-1-3-2-2">
<p>
list|column|insert|line|tabs|tcl|csv
</p>
</div>
</div>

<div id="outline-container-sec-1-3-2-3" class="outline-5">
<h5 id="sec-1-3-2-3"><span class="section-number-5">1.3.2.3</span> .dump</h5>
</div>
<div id="outline-container-sec-1-3-2-4" class="outline-5">
<h5 id="sec-1-3-2-4"><span class="section-number-5">1.3.2.4</span> .read</h5>
</div>
<div id="outline-container-sec-1-3-2-5" class="outline-5">
<h5 id="sec-1-3-2-5"><span class="section-number-5">1.3.2.5</span> .tables</h5>
</div>
<div id="outline-container-sec-1-3-2-6" class="outline-5">
<h5 id="sec-1-3-2-6"><span class="section-number-5">1.3.2.6</span> .separator</h5>
</div>
<div id="outline-container-sec-1-3-2-7" class="outline-5">
<h5 id="sec-1-3-2-7"><span class="section-number-5">1.3.2.7</span> .schema</h5>
</div>
<div id="outline-container-sec-1-3-2-8" class="outline-5">
<h5 id="sec-1-3-2-8"><span class="section-number-5">1.3.2.8</span> .headers [on|off]</h5>
</div>
<div id="outline-container-sec-1-3-2-9" class="outline-5">
<h5 id="sec-1-3-2-9"><span class="section-number-5">1.3.2.9</span> explain query plan</h5>
<div class="outline-text-5" id="text-1-3-2-9">
<p>
see also <a href="http://www.sqlite.org/queryplanner.html">queryplanner</a>
</p>
<div class="org-src-container">

<pre class="src src-sql">explain query plan select * from foo;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3-2-10" class="outline-5">
<h5 id="sec-1-3-2-10"><span class="section-number-5">1.3.2.10</span> explain</h5>
<div class="outline-text-5" id="text-1-3-2-10">
<div class="org-src-container">

<pre class="src src-sql">explain select * from foo;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3-2-11" class="outline-5">
<h5 id="sec-1-3-2-11"><span class="section-number-5">1.3.2.11</span> vacuum</h5>
</div>
</div>

<div id="outline-container-sec-1-3-3" class="outline-4">
<h4 id="sec-1-3-3"><span class="section-number-4">1.3.3</span> sqlite SQL</h4>
<div class="outline-text-4" id="text-1-3-3">
</div><div id="outline-container-sec-1-3-3-1" class="outline-5">
<h5 id="sec-1-3-3-1"><span class="section-number-5">1.3.3.1</span> attach database</h5>
<div class="outline-text-5" id="text-1-3-3-1">
<p>
attach database "foo.db" as db2;
select * from db2.tbl<sub>1</sub>;
detach database db2;
</p>
</div>
</div>

<div id="outline-container-sec-1-3-3-2" class="outline-5">
<h5 id="sec-1-3-3-2"><span class="section-number-5">1.3.3.2</span> create table</h5>
<div class="outline-text-5" id="text-1-3-3-2">
</div><ol class="org-ol"><li>storage class<br  /><div class="outline-text-6" id="text-1-3-3-2-1">
<p>
使用 select typeof (xx) 来查看 storage class
</p>

<ul class="org-ul">
<li>integer
</li>
</ul>
<p>
61
</p>
<ul class="org-ul">
<li>real
</li>
</ul>
<p>
61.0
</p>
<ul class="org-ul">
<li>text
</li>
</ul>
<p>
"a"
</p>
<ul class="org-ul">
<li>blob
</li>
</ul>
<p>
x'61'
</p>
</div>
</li>
<li>constrains<br  /><ol class="org-ol"><li>column-level constrains<br  /><div class="outline-text-7" id="text-1-3-3-2-2-1">
<ul class="org-ul">
<li>not null
</li>
<li>unique
</li>
<li>primary key
</li>
<li>foreign key
</li>
<li>check
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">create temp table foo(
x integer,
y integer check (y&gt;x),
z integer check (z&gt;abs(y)),
);
</pre>
</div>
<p>
see also `trigger`
</p>
<ul class="org-ul">
<li>collate
<ul class="org-ul">
<li>binary
</li>
<li>nocase
</li>
</ul>
</li>
<li>default
</li>
<li>autoincrement
</li>
</ul>
</div>
</li>

<li>table-level constrains<br  /><div class="outline-text-7" id="text-1-3-3-2-2-2">
<ul class="org-ul">
<li>primary key
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">CREATE TABLE xxx (
data1 text,
data2 text,
primary key (data1, data2)
);
</pre>
</div>
<ul class="org-ul">
<li>unique
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">CREATE TABLE xxx (
_id integer primary key,
data1 text,
data2 text,
unique (data1, data2)
);
</pre>
</div>
<ul class="org-ul">
<li>check
</li>
</ul>
</div>
</li></ol>
</li></ol>
</div>

<div id="outline-container-sec-1-3-3-3" class="outline-5">
<h5 id="sec-1-3-3-3"><span class="section-number-5">1.3.3.3</span> trigger</h5>
<div class="outline-text-5" id="text-1-3-3-3">
<div class="org-src-container">

<pre class="src src-sql">create [temp|temporary] trigger name
[before|after|instead of] [insert|delete|update|update of columns] on table
[for each row] [when expr]
begin
action
end;
</pre>
</div>
<ul class="org-ul">
<li>using trigger to update view
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">create trigger on_update_foods_view
instead of update on foods_view
for each row
begin
   update foods set name=new.fname where id=new.fid;
   update food_types set name=new.tname where id=new.tid;
end;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3-3-4" class="outline-5">
<h5 id="sec-1-3-3-4"><span class="section-number-5">1.3.3.4</span> transaction</h5>
<div class="outline-text-5" id="text-1-3-3-4">
<ul class="org-ul">
<li>begin
</li>
<li>commit
</li>
<li>rollback
</li>
<li>savepoint
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">begin transaction;
insert into xxx;
...
savepoint test
...
rollback to test
...
commit
</pre>
</div>
<p>
insert into xxx;
save
</p>
</div>
</div>

<div id="outline-container-sec-1-3-3-5" class="outline-5">
<h5 id="sec-1-3-3-5"><span class="section-number-5">1.3.3.5</span> confict resolution</h5>
<div class="outline-text-5" id="text-1-3-3-5">
<ul class="org-ul">
<li>replace
</li>
<li>ignore
忽略本次错误, 继续执行
</li>
<li>fail
结束, 但不回滚
</li>
<li>abort
default
回滚, 然后结束
</li>
<li>rollback
回滚, 但不结束
</li>
</ul>

<p>
confict resolution can be specified in
</p>
<ul class="org-ul">
<li>table or view defination
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">create temp table cast(name text unique on conflict rollback);
</pre>
</div>
<ul class="org-ul">
<li>in `insert`, `update`
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">insert or replace into table values (xxx);
</pre>
</div>
<ul class="org-ul">
<li>trigger
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-3-3-6" class="outline-5">
<h5 id="sec-1-3-3-6"><span class="section-number-5">1.3.3.6</span> join</h5>
<div class="outline-text-5" id="text-1-3-3-6">
<ul class="org-ul">
<li>inner join
</li>
</ul>
<p>
join
</p>
<ul class="org-ul">
<li>left outer join
</li>
</ul>
<p>
left out join
</p>
<ul class="org-ul">
<li>right outer join
</li>
</ul>
<p>
not supported
</p>
<ul class="org-ul">
<li>full outer join
</li>
</ul>
<p>
not supported
</p>
<ul class="org-ul">
<li>cross
</li>
</ul>
<p>
select from tbl1, tbl2
</p>
</div>
</div>

<div id="outline-container-sec-1-3-3-7" class="outline-5">
<h5 id="sec-1-3-3-7"><span class="section-number-5">1.3.3.7</span> index</h5>
<div class="outline-text-5" id="text-1-3-3-7">
<p>
refers <a href="#sec-1-3-2-9">1.3.2.9</a> to delete whether index is used for optimization
</p>

<ul class="org-ul">
<li>index
</li>
<li>unique index
</li>
<li>covering index
covering index 是指同一个 index 中有多个字段, 查找时直接从 index 中
取得了数据, 而不是从 index 取得主键, 再到主表获取数据. 例如:

<p>
create index m3<sub>index</sub> on foo(x,y);
explain query plan select y from foo where x="a";
</p>
</li>
</ul>

<p>
0|0|0|SEARCH TABLE foo USING COVERING INDEX m3<sub>index</sub> (x=?) (~10 rows)
</p>

<p>
Note:
</p>
<ul class="org-ul">
<li>collate 会影响 index, 例如若 select 时或建表时使用的 collate 与建立
index 时指定的 collate 不一致时, index 无法起作用.
</li>
<li>create index 可以指定多个字段 (以利于形成 covering index), 但多个字
段是联合在一起索引的, 例如 (x,y,z), 则使用 x, x and y, x and y and
z 时索引起作用, 但使用 y and z, z 时不起作用.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-3-3-8" class="outline-5">
<h5 id="sec-1-3-3-8"><span class="section-number-5">1.3.3.8</span> view</h5>
<div class="outline-text-5" id="text-1-3-3-8">
<ul class="org-ul">
<li>using trigger to update view
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-3-3-9" class="outline-5">
<h5 id="sec-1-3-3-9"><span class="section-number-5">1.3.3.9</span> insert</h5>
</div>
<div id="outline-container-sec-1-3-3-10" class="outline-5">
<h5 id="sec-1-3-3-10"><span class="section-number-5">1.3.3.10</span> update</h5>
</div>
<div id="outline-container-sec-1-3-3-11" class="outline-5">
<h5 id="sec-1-3-3-11"><span class="section-number-5">1.3.3.11</span> select</h5>
<div class="outline-text-5" id="text-1-3-3-11">
<pre class="example">
          -+-------------------------------------------------------------------------------------+
           |       -+-----------------------------------------------------------+                |        result
           |        |                        -+---------------+                 |                |          ^
           |        |                         |               |                 |                |          |
SELECT DISTINCT heading FROM tables WHERE predicate GROUP BY columns HAVING predicate ORDER BY columns LIMIT init,int;
           | 6      | 5         | 1           | 2             | 3               | 4              | 7        | 8
           |        |           |             |               |                 |                |          |
          -+--------+          -+-------------+              -+-----------------+               -+----------+
</pre>
</div>
<ol class="org-ol"><li>distinct<br  /><div class="outline-text-6" id="text-1-3-3-11-1">
<p>
distinct 可以同时修饰多个字段
</p>
<div class="org-src-container">

<pre class="src src-sql">select distinct id, name from xxx;
</pre>
</div>
<p>
表示只有 (id,name) 都相同时才算相同
</p>
</div>
</li>

<li>where<br  /></li>
<li>group by<br  /></li>
<li>having<br  /></li>
<li>order by<br  /></li>
<li>limit<br  /></li>
<li>sub-query<br  /><div class="outline-text-6" id="text-1-3-3-11-7">
<ul class="org-ul">
<li>for `select`
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">select _id, (select name from xx where _id=f._id ) from xx as f;
</pre>
</div>
<ul class="org-ul">
<li>for `from`
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">select _id from (select _id,name from xxx);
</pre>
</div>
<ul class="org-ul">
<li>for `order by`
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">select _id from xxx as f order by (select score from xxx where _id=f._id);
</pre>
</div>
<ul class="org-ul">
<li>for `where'
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql">select _id from xxx where _id in (select _id from xxx);
</pre>
</div>

<p>
Note:
</p>
<ul class="org-ul">
<li>sub-query 几乎可以用在任何地方
</li>
<li>sub-query 通常需要设置别名
</li>
<li>sub-query 只能返回一列.
</li>
<li>sub-query 有时需要返回一行 (例如在 order by 的场合), 这时若返回多行,
则系统只会使用第一行.
</li>
</ul>
</div>
</li>

<li>compound query<br  /><div class="outline-text-6" id="text-1-3-3-11-8">
<p>
compound query 要求各个查询返回相同的例, 且只能在 compound query 最后
有一个 order by
</p>
</div>
<ol class="org-ol"><li>union [all]<br  /><div class="outline-text-7" id="text-1-3-3-11-8-1">
<p>
a | b
</p>
</div>
</li>

<li>intercept<br  /><div class="outline-text-7" id="text-1-3-3-11-8-2">
<p>
a &amp; b
</p>
</div>
</li>

<li>except<br  /><div class="outline-text-7" id="text-1-3-3-11-8-3">
<p>
a - b
</p>
</div>
</li></ol>
</li>

<li>conditional result<br  /><div class="outline-text-6" id="text-1-3-3-11-9">
<p>
used to transform column values
</p>
<div class="org-src-container">

<pre class="src src-sql">case value
  when x then value_x
  when y then value_y
  when z then value_z
  else default_value
end
</pre>
</div>
<div class="org-src-container">

<pre class="src src-sql">select name,(select
              case
              when count(*) &gt; 4 then <span style="color: #2aa198;">'Very High'</span>
              when count(*) = 4 then <span style="color: #2aa198;">'High'</span>
              when count(*) in (2,3) then <span style="color: #2aa198;">'Moderate'</span>
              else <span style="color: #2aa198;">'Low'</span>
              end
              from foods_episodes
              where food_id=f.id) as frequency
from foods f
where frequency like <span style="color: #2aa198;">'%High'</span>
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-3-3-12" class="outline-5">
<h5 id="sec-1-3-3-12"><span class="section-number-5">1.3.3.12</span> functions</h5>
<div class="outline-text-5" id="text-1-3-3-12">
</div><ol class="org-ol"><li>core functions<br  /><div class="outline-text-6" id="text-1-3-3-12-1">
<ul class="org-ul">
<li>LAST<sub>INSERT</sub><sub>ROWID</sub>()
</li>
<li>coalesce (x, y, z, &#x2026;)
return the first not null value, or null

<p>
e.g. coalesce (null, 1, 2, null) returns 1
</p>
</li>
<li>ifnull (x, y)
ifnull (x, y) &lt;==&gt; coalesce(x, y)
</li>
<li>nullif (x, y)
若 x,y 相同返回 null, 否则返回 x.
</li>
<li>glob
</li>
<li>like
</li>
<li>substr
</li>
<li>trim
</li>
<li>ltrim
</li>
<li>rtrim
</li>
<li>instr
</li>
<li>quote
</li>
<li>length
</li>
<li>lower
</li>
<li>upper
</li>
<li>abs
</li>
<li>max
</li>
<li>min
</li>
<li>random
</li>
<li>replace
</li>
<li>hex
</li>
<li>round
</li>
<li>date
</li>
</ul>
</div>
</li>

<li>aggregation function<br  /><div class="outline-text-6" id="text-1-3-3-12-2">
<ul class="org-ul">
<li>avg
</li>
<li>sum
</li>
<li>total
</li>
<li>max
</li>
<li>min
</li>
<li>count (x)
</li>
<li>count (*)
</li>
</ul>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-3-3-13" class="outline-5">
<h5 id="sec-1-3-3-13"><span class="section-number-5">1.3.3.13</span> fts</h5>
</div>
<div id="outline-container-sec-1-3-3-14" class="outline-5">
<h5 id="sec-1-3-3-14"><span class="section-number-5">1.3.3.14</span> Summary</h5>
<div class="outline-text-5" id="text-1-3-3-14">
</div><ol class="org-ol"><li>cross-join != full-outer-join<br  /></li>
<li>having 与 where 的区别<br  /><div class="outline-text-6" id="text-1-3-3-14-2">
<ul class="org-ul">
<li>haveing 发生在 group by 之后, 而 where 发生在 group by 之前;
</li>
<li>可以使用 aggregation 函数
</li>
</ul>
</div>
</li>

<li>aggregation 函数只可以使用在 select 之后和 having 之后<br  /></li>
<li>使用两个 left-outer-join 模拟 full-outer-join<br  /></li>
<li>distinct 可以使用 group by 来模拟<br  /></li>
<li>compound query 只允许在最后使用一个 order-by, 不过可以用 sub-query 来跳过这一限制<br  /></li>
<li>sub-query 几乎可以使用在任何地方, 不过只允许返回一列, 但可以返回多行 (虽然有时只有第一行有效)<br  /></li>
<li>sqlite 允许在有 group by 中查询中 select group-by 之外的字段, 只是结果是不可靠的. 例如:<br  /><div class="outline-text-6" id="text-1-3-3-14-8">
<div class="org-src-container">

<pre class="src src-sql">select name, id from xxx group by id;
</pre>
</div>

<p>
同理适用于 aggregation functions, 例如:
</p>

<div class="org-src-container">

<pre class="src src-sql">select *, count(*) from xxx;
</pre>
</div>
</div>
</li>
<li>integer primary key =&gt; autoincrement (but with filling-gaps)<br  /></li>
<li>autoincrement 会导致后续的值一定比之前的大 (不会有 filling-gaps 效果), 当到达最大值后, 返回 data is full error<br  /><div class="outline-text-6" id="text-1-3-3-14-10">
<p>
这一点需要与 integer primary key 区别
</p>
</div>
</li>

<li>autoincrement 必须在 integer primary key 后使用<br  /></li>
<li>storage class vs. sort<br  /><div class="outline-text-6" id="text-1-3-3-14-12">
<p>
storage class 与列的定义无关, 它取决了输入的数据的格式:
61, 61,0, "a", x'61', null 的 storage class 分别为 integer, real,
text, blob, null
</p>

<p>
不同的 storage class 的排序规则:
null &lt; integer = real &lt; text &lt; blob
</p>

<p>
see also <i>type affinity</i>
</p>
</div>
</li>

<li>sqlite 的 view 是不可修改的, 但可以用 trigger 来模拟实现可修改的 view<br  /></li>
<li>index 可以同时指定多个字段, 以便使用 covering index, 但要注意查询条件, 例如<br  /><div class="outline-text-6" id="text-1-3-3-14-14">
<p>
(x,y,z)三个字段的索引,使用 x, x and y, x and y and z 会使用索引, 但
y, y and z, z 不会.
</p>
</div>
</li>

<li>一次查询可能会使用多个索引, 例如使用 or 的情况下:<br  /><div class="outline-text-6" id="text-1-3-3-14-15">
<p>
create index m1<sub>index</sub> on foo(x);
create index m1<sub>index</sub> on foo(y);
select x from foo where x="a" or y="a";
0|0|0|SEARCH TABLE foo USING INDEX m1<sub>index</sub> (x=?) (~10 rows)
0|0|0|SEARCH TABLE foo USING INDEX m2<sub>index</sub> (y=?) (~10 rows)
</p>
</div>
</li>

<li>unique index<br  /></li>
<li>有些情况下 index 无法使用, 例如<br  /><div class="outline-text-6" id="text-1-3-3-14-17">
<ul class="org-ul">
<li>glob "a*"
</li>
<li>like (测试了下似乎 sqlite 并不会对 like 进行优化, 可能和版本有关?)
</li>
<li>多列索引时有些情况
</li>
<li>select xx from xx where length(x)=5, 等
</li>
</ul>
</div>
</li>

<li>savepoint &amp; rollback to<br  /></li>
<li>conflict resolution<br  /></li>
<li>attach database<br  /></li></ol>
</div>
</div>

<div id="outline-container-sec-1-3-4" class="outline-4">
<h4 id="sec-1-3-4"><span class="section-number-4">1.3.4</span> sqlite internal</h4>
<div class="outline-text-4" id="text-1-3-4">
</div><div id="outline-container-sec-1-3-4-1" class="outline-5">
<h5 id="sec-1-3-4-1"><span class="section-number-5">1.3.4.1</span> concurrent &amp; lock</h5>
<div class="outline-text-5" id="text-1-3-4-1">
<p>
sqlite 在不同的层次上定义了三种锁
</p>
</div>
<ol class="org-ol"><li>thread lock<br  /><div class="outline-text-6" id="text-1-3-4-1-1">
<ul class="org-ul">
<li>shared cache mode lock
<ul class="org-ul">
<li>threading modes lock
</li>
</ul>
</li>
</ul>
</div>
</li>

<li>db file lock<br  /><ol class="org-ol"><li>lock<br  /><div class="outline-text-7" id="text-1-3-4-1-2-1">
<p>
这里的 lock 是指数据库级别的文件锁.
实际上, 为了实现这种多状态的锁, sqlite 针对 sqlite db 文件的三块区域定
义了三个读写锁, 通过对不同的区域的锁定实现不同的状态.
</p>

<pre class="example">
                         read
                 -+------------------------------------+
                  |                exclusive           |
                  |          -+------------------------+--------+
 -+---+        -+-+-+  write  | -+---+---+---+---+---+-v-+----+ |
  |  -+--------&gt;+  -+--------&gt;+  +   |   |   |   |   |   |    | |
 -+-+-+        -+---+         | -+---+---+---+---+---+-+-+----+ |
rese|rved       pending       |          shared        |        |
    ^         (starting)     -+------------------------+--------+
   -+--------------------------------------------------+
</pre>

<ul class="org-ul">
<li>pending
</li>
<li>unlocked
</li>
<li>shared
</li>
</ul>
<p>
执行任何语句前要进行 shared 状态
</p>
<ul class="org-ul">
<li>reserved
执行任何写语句前需要首先进入 reserved 状态

<p>
shared 想升级为 reserved, 必须保证当前没有任何 reserved 及 exclusive lock
</p>
</li>
<li>exclusive
<ul class="org-ul">
<li>pending

<p>
commit 前需要进行 pending 状态
</p>

<p>
reserved 升级为 exclusive 时会先暂时的升级为 pending, pending lock 会禁止任
何新的 lock 的获取, 包括 shared, 否则可以会因为不停的有新的 shared lock 进入
而导致 reserved 永远无法升级为 exclusive.
</p>
</li>
</ul>
<p>
reserved要想升级为 exclusive, 必须保证当前没有任何其他的 lock, 包含 shared
</p>
</li>
</ul>
</div>
</li>

<li>dead lock example<br  /><div class="outline-text-7" id="text-1-3-4-1-2-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">A connection</th>
<th scope="col" class="left">B connection</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">BEGIN;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">BEGIN;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left"># acquiring `reserved` lock ok</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">INSERT INTO foo values("bar")</td>
</tr>

<tr>
<td class="left"># acquiring `shared` lock ok</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">SELECT * from foo</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left"># acquiring `exclusive` lock failed<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup></td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">COMMIT;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">SQL error: database is locked</td>
</tr>

<tr>
<td class="left"># acquiring `reserved` lock failed<sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup></td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">INSERT INTO foo values ("bar")</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">SQL error: database is locked</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</li>
<li>transaction<br  /><div class="outline-text-7" id="text-1-3-4-1-2-3">
<ul class="org-ul">
<li>begin [deferred]
</li>
<li>begin immediate
</li>
<li>begin exclusive
</li>
</ul>
</div>
</li></ol>
</li></ol>
</div>
<div id="outline-container-sec-1-3-4-2" class="outline-5">
<h5 id="sec-1-3-4-2"><span class="section-number-5">1.3.4.2</span> threads</h5>
<div class="outline-text-5" id="text-1-3-4-2">
</div><ol class="org-ol"><li>Shared Cache Mode<br  /><div class="outline-text-6" id="text-1-3-4-2-1">
<p>
shared cache mode 主要应用在嵌入式系统中, 可以使同一个进程的多个
connection 共享 page cache, 以显著的降低内存和 io 的消耗. 但这需要引入
额外的锁机制, 导致多个线程同时查询时速度非常慢
</p>

<p>
shared cache mode 的比较:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">MULTITHREAD, 三个线程同时查询</th>
<th scope="col" class="left">每个线程的 rss</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">未使用 shared cache mode</td>
<td class="left">8M</td>
</tr>

<tr>
<td class="left">使用 shared cache mode</td>
<td class="left">3.3M</td>
</tr>
</tbody>
</table>
</div>


<ol class="org-ol"><li>Read Uncommitted Isolation Level<br  /></li></ol>
</li>

<li>threading modes<br  /><div class="outline-text-6" id="text-1-3-4-2-2">
<p>
<a href="http://www.sqlite.org/threadsafe.html">http://www.sqlite.org/threadsafe.html</a>
</p>

<p>
SQLite support three different threading modes:
</p>

<ul class="org-ul">
<li>SINGLETHREAD
</li>
</ul>

<p>
In this mode, all mutexes are disabled and SQLite is unsafe to use in
more than a single thread at once.
</p>

<p>
同时只能有一个线程在使用 connection (相同或不同的), 否则出现段错误.
</p>

<ul class="org-ul">
<li>MULTITHREAD
</li>
</ul>

<p>
In this mode, SQLite can be safely used by multiple threads provided
that no single database connection is used simultaneously in two or
more threads.
</p>

<p>
同时可以有多个线程使用 connection (不同的), 否则段错误.
</p>

<ul class="org-ul">
<li>SERIALIZED
</li>
</ul>

<p>
In serialized mode, SQLite can be safely used by multiple threads with
no restriction.
</p>

<p>
The threading mode can be selected at compile-time (when the SQLite
library is being compiled from source code) or at start-time (when the
application that intends to use SQLite is initializing) or at run-time
(when a new SQLite database connection is being created). Generally
speaking, run-time overrides start-time and start-time overrides
compile-time. Except, single-thread mode cannot be overridden once
selected.
</p>

<p>
The default mode is serialized.
</p>

<p>
在 android 4.0 上, 该配置在编译时设为 SERIALIZED, 在 android 4.1 变为 MULTITHREAD
</p>

<p>
同时可以有多个线程使用 connection (相同或不同的)
</p>
</div>

<ol class="org-ol"><li>Benchmark<br  /><div class="outline-text-7" id="text-1-3-4-2-2-1">
<p>
查询 1600 W 条记录所耗的时间的比较
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">查询类型</th>
<th scope="col" class="right">real</th>
<th scope="col" class="right">user</th>
<th scope="col" class="right">sys</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">使用 SINGLETHREAD 查询一次</td>
<td class="right">3.5</td>
<td class="right">3.5</td>
<td class="right">0.4</td>
</tr>

<tr>
<td class="left">使用 MULTITHREAD 查询一次</td>
<td class="right">3.5</td>
<td class="right">3.5</td>
<td class="right">0.4</td>
</tr>

<tr>
<td class="left">使用 SERIALZIED 查询一次</td>
<td class="right">3.8</td>
<td class="right">3.8</td>
<td class="right">0.4</td>
</tr>

<tr>
<td class="left">使用 MULTITHREAD 在两个线程使用不同的 connection 查询</td>
<td class="right">7.3</td>
<td class="right">4</td>
<td class="right">0.4</td>
</tr>

<tr>
<td class="left">使用 MULTITHREAD 在两个线程使用不同的 connection 查询</td>
<td class="right">7.8</td>
<td class="right">4.2</td>
<td class="right">0.4</td>
</tr>

<tr>
<td class="left">使用 MULTITHREAD 在两个线程使用相同的 connection 查询</td>
<td class="right">27</td>
<td class="right">28</td>
<td class="right">9</td>
</tr>

<tr>
<td class="left">使用 SHARED CACHE MODE 在两个线程中使用不同的 connection 查询</td>
<td class="right">31</td>
<td class="right">31</td>
<td class="right">11</td>
</tr>
</tbody>
</table>

<p>
可见,
</p>

<ul class="org-ul">
<li>不使用多线程的情况下, SINGLETHREAD 和 MULTITHREAD 差不多,SERIALZIED
变慢
</li>
<li>使用多线程的情况下,
<ul class="org-ul">
<li>SINGLETHREAD 无法使用
</li>
<li>MULTITHREAD 可以利用多线程显著的降低 real time
</li>
<li>SERIALZIED 使用不同的线程时也比 MULTITHREAD 稍慢
</li>
<li>SERIALZIED 使用相同的线程时速度无法接受
</li>
</ul>
</li>
</ul>

<p>
综上, 使用 MULTITHREAD 多线程使用不同的 connection 是最好的选择.
</p>
</div>
</li>
<li>Compile-time selection of threading mode<br  /><div class="outline-text-7" id="text-1-3-4-2-2-2">
<p>
Use the SQLITE<sub>THREADSAFE</sub> compile-time parameter to selected the
threading mode. If no SQLITE<sub>THREADSAFE</sub> compile-time parameter is
present, then serialized mode is used. This can be made explicit with
-DSQLITE<sub>THREADSAFE</sub>=1. With -DSQLITE<sub>THREADSAFE</sub>=0 the threading mode
is single-thread. With -DSQLITE<sub>THREADSAFE</sub>=2 the threading mode is
multi-thread.
</p>

<p>
The return value of the sqlite3<sub>threadsafe</sub>() interface is determined
by the compile-time threading mode selection. If single-thread mode is
selected at compile-time, then sqlite3<sub>threadsafe</sub>() returns false. If
either the multi-thread or serialized modes are selected, then
sqlite3<sub>threadsafe</sub>() returns true. The sqlite3<sub>threadsafe</sub>() interface
predates the multi-thread mode and start-time and run-time mode
selection and so is unable to distinguish between multi-thread and
serialized mode nor is it able to report start-time or run-time mode
changes.
</p>

<p>
If single-thread mode is selected at compile-time, then critical
mutexing logic is omitted from the build and it is impossible to
enable either multi-thread or serialized modes at start-time or
run-time.
</p>
</div>
</li>
<li>Start-time selection of threading mode<br  /><div class="outline-text-7" id="text-1-3-4-2-2-3">
<p>
Assuming that the compile-time threading mode is not single-thread,
then the threading mode can be changed during initialization using the
sqlite3<sub>config</sub>() interface. The SQLITE<sub>CONFIG</sub><sub>SINGLETHREAD</sub> verb puts
SQLite into single-thread mode, the SQLITE<sub>CONFIG</sub><sub>MULTITHREAD</sub> verb
sets multi-thread mode, and the SQLITE<sub>CONFIG</sub><sub>SERIALIZED</sub> verb sets
serialized mode.
</p>
</div>
</li>
<li>Run-time selection of threading mode<br  /><div class="outline-text-7" id="text-1-3-4-2-2-4">
<p>
If single-thread mode has not been selected at compile-time or
start-time, then individual database connections can be created as
either multi-thread or serialized. It is not possible to downgrade an
individual database connection to single-thread mode. Nor is it
possible to escalate an individual database connection if the
compile-time or start-time mode is single-thread.
</p>

<p>
The threading mode for an individual database connection is determined
by flags given as the third argument to sqlite3<sub>open</sub><sub>v2</sub>(). The
SQLITE<sub>OPEN</sub><sub>NOMUTEX</sub> flag causes the database connection to be in the
multi-thread mode and the SQLITE<sub>OPEN</sub><sub>FULLMUTEX</sub> flag causes the
connection to be in serialized mode. If neither flag is specified or
if sqlite3<sub>open</sub>() or sqlite3<sub>open16</sub>() are used instead of
sqlite3<sub>open</sub><sub>v2</sub>(), then the default mode determined by the
compile-time and start-time settings is used.
</p>
</div>
</li></ol>
</li></ol>
</div>
<div id="outline-container-sec-1-3-4-3" class="outline-5">
<h5 id="sec-1-3-4-3"><span class="section-number-5">1.3.4.3</span> Can multiple applications or multiple instances of the same application access a single database file at the same time?</h5>
<div class="outline-text-5" id="text-1-3-4-3">
<p>
<a href="http://www.sqlite.org/faq.html#q5">http://www.sqlite.org/faq.html#q5</a>
</p>

<p>
Multiple processes can have the same database open at the same
time. Multiple processes can be doing a SELECT at the same time. But
only one process can be making changes to the database at any moment
in time, however.
</p>

<p>
SQLite uses reader/writer locks to control access to the
database. (Under Win95/98/ME which lacks support for reader/writer
locks, a probabilistic simulation is used instead.) But use caution:
this locking mechanism might not work correctly if the database file
is kept on an NFS filesystem. This is because fcntl() file locking is
broken on many NFS implementations. You should avoid putting SQLite
database files on NFS if multiple processes might try to access the
file at the same time. On Windows, Microsoft's documentation says that
locking may not work under FAT filesystems if you are not running the
Share.exe daemon. People who have a lot of experience with Windows
tell me that file locking of network files is very buggy and is not
dependable. If what they say is true, sharing an SQLite database
between two or more Windows machines might cause unexpected problems.
</p>

<p>
We are aware of no other embedded SQL database engine that supports as
much concurrency as SQLite. SQLite allows multiple processes to have
the database file open at once, and for multiple processes to read the
database at once. When any process wants to write, it must lock the
entire database file for the duration of its update. But that normally
only takes a few milliseconds. Other processes just wait on the writer
to finish then continue about their business. Other embedded SQL
database engines typically only allow a single process to connect to
the database at once.
</p>

<p>
However, client/server database engines (such as PostgreSQL, MySQL, or
Oracle) usually support a higher level of concurrency and allow
multiple processes to be writing to the same database at the same
time. This is possible in a client/server database because there is
always a single well-controlled server process available to coordinate
access. If your application has a need for a lot of concurrency, then
you should consider using a client/server database. But experience
suggests that most applications need much less concurrency than their
designers imagine.
</p>

<p>
When SQLite tries to access a file that is locked by another process,
the default behavior is to return SQLITE<sub>BUSY</sub>. You can adjust this
behavior from C code using the sqlite3<sub>busy</sub><sub>handler</sub>() or
sqlite3<sub>busy</sub><sub>timeout</sub>() API functions.
</p>
</div>
</div>
<div id="outline-container-sec-1-3-4-4" class="outline-5">
<h5 id="sec-1-3-4-4"><span class="section-number-5">1.3.4.4</span> Is SQLite threadsafe?</h5>
<div class="outline-text-5" id="text-1-3-4-4">
<p>
<a href="http://www.sqlite.org/faq.html#q6">http://www.sqlite.org/faq.html#q6</a>
</p>

<p>
Threads are evil. Avoid them.
</p>

<p>
SQLite is threadsafe. We make this concession since many users choose
to ignore the advice given in the previous paragraph. But in order to
be thread-safe, SQLite must be compiled with the SQLITE<sub>THREADSAFE</sub>
preprocessor macro set to 1. Both the Windows and Linux precompiled
binaries in the distribution are compiled this way. If you are unsure
if the SQLite library you are linking against is compiled to be
threadsafe you can call the sqlite3<sub>threadsafe</sub>() interface to find
out.
</p>

<p>
Prior to version 3.3.1, an sqlite3 structure could only be used in the
same thread that called sqlite3<sub>open</sub>() to create it. You could not
open a database in one thread then pass the handle off to another
thread for it to use. This was due to limitations (bugs?) in many
common threading implementations such as on RedHat9. Specifically, an
fcntl() lock created by one thread cannot be removed or modified by a
different thread on the troublesome systems. And since SQLite uses
fcntl() locks heavily for concurrency control, serious problems arose
if you start moving database connections across threads.
</p>

<p>
The restriction on moving database connections across threads was
relaxed somewhat in version 3.3.1. With that and subsequent versions,
it is safe to move a connection handle across threads as long as the
connection is not holding any fcntl() locks. You can safely assume
that no locks are being held if no transaction is pending and all
statements have been finalized.
</p>

<p>
Under Unix, you should not carry an open SQLite database across a
fork() system call into the child process. Problems will result if you
do.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-1-3-5" class="outline-4">
<h4 id="sec-1-3-5"><span class="section-number-4">1.3.5</span> sqlite limitation</h4>
<div class="outline-text-4" id="text-1-3-5">
<ul class="org-ul">
<li>right and full outer join
</li>
<li>complete ALTER TABLE support
</li>
<li>completing TRIGGER support
</li>
<li>writing to VIEWs
</li>
<li>GRAND and REVOKE
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-3-6" class="outline-4">
<h4 id="sec-1-3-6"><span class="section-number-4">1.3.6</span> sqlite pragma</h4>
<div class="outline-text-4" id="text-1-3-6">
</div><div id="outline-container-sec-1-3-6-1" class="outline-5">
<h5 id="sec-1-3-6-1"><span class="section-number-5">1.3.6.1</span> auto<sub>vacuum</sub> = 0/1</h5>
</div>
<div id="outline-container-sec-1-3-6-2" class="outline-5">
<h5 id="sec-1-3-6-2"><span class="section-number-5">1.3.6.2</span> cache<sub>size</sub></h5>
<div class="outline-text-5" id="text-1-3-6-2">
<p>
cache<sub>size</sub> 表示 writer 在真正 flush 日志文件和 page cache 之前, 最多
能 cache 多少修改.
</p>
</div>
</div>
<div id="outline-container-sec-1-3-6-3" class="outline-5">
<h5 id="sec-1-3-6-3"><span class="section-number-5">1.3.6.3</span> default<sub>cache</sub><sub>size</sub></h5>
</div>
<div id="outline-container-sec-1-3-6-4" class="outline-5">
<h5 id="sec-1-3-6-4"><span class="section-number-5">1.3.6.4</span> case<sub>sensitive</sub><sub>like</sub> = 0/1</h5>
</div>
<div id="outline-container-sec-1-3-6-5" class="outline-5">
<h5 id="sec-1-3-6-5"><span class="section-number-5">1.3.6.5</span> count<sub>change</sub> = 0/1</h5>
</div>
<div id="outline-container-sec-1-3-6-6" class="outline-5">
<h5 id="sec-1-3-6-6"><span class="section-number-5">1.3.6.6</span> encoding = "UTF-8"</h5>
</div>
<div id="outline-container-sec-1-3-6-7" class="outline-5">
<h5 id="sec-1-3-6-7"><span class="section-number-5">1.3.6.7</span> page<sub>size</sub> = bytes</h5>
</div>
<div id="outline-container-sec-1-3-6-8" class="outline-5">
<h5 id="sec-1-3-6-8"><span class="section-number-5">1.3.6.8</span> synchronous = FULL/NORMAL/OFF</h5>
<div class="outline-text-5" id="text-1-3-6-8">
<p>
synchronous 表示 write 在 commit 或 cache 满后如何 flush 日志文件.
</p>

<p>
特别的,在 WAL 模式下, synchronous 为 NORMAL 时 commit 也不再写数据库,
只有checkout 时才刷新.
</p>
</div>
</div>

<div id="outline-container-sec-1-3-6-9" class="outline-5">
<h5 id="sec-1-3-6-9"><span class="section-number-5">1.3.6.9</span> vdbe<sub>trace</sub>=ON/OFF</h5>
</div>
</div>

<div id="outline-container-sec-1-3-7" class="outline-4">
<h4 id="sec-1-3-7"><span class="section-number-4">1.3.7</span> references</h4>
<div class="outline-text-4" id="text-1-3-7">
<p>
<a href="http://www.sqlite.org/syntaxdiagrams.html">Syntax Diagrams For SQLite</a>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Benchmark</h3>
<div class="outline-text-3" id="text-1-4">
<p>
分别使用c,java 程序插入10w条记录, 设置 synchronous 为 full 或 off, 保
存数据库文件到 sdcard 或 mtd 设备. java 程序使用 execSQL 或
InsertHelper.
</p>

<ul class="org-ul">
<li>java 测试程序
</li>
</ul>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">writeDatabase</span>() {
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">mtd test: use /data/test.db to  mtd</span>
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">sd test: use  /storage/sdcard1/test.db</span>
    <span style="color: #b58900;">SQLiteDatabase</span> <span style="color: #268bd2;">db</span> = SQLiteDatabase.openDatabase(<span style="color: #2aa198;">"/data/test.db"</span>, <span style="color: #2aa198;">null</span>,<span style="color: #2aa198;">SQLiteDatabase</span>.OPEN_READWRITE, <span style="color: #2aa198;">null</span>);
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">synchronous = full</span>
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">synchronous = off</span>
    db.execSQL(<span style="color: #2aa198;">"pragma synchronous=full"</span>);
    <span style="color: #b58900;">long</span> <span style="color: #268bd2;">startTime</span>=System.currentTimeMillis();
    <span style="color: #b58900;">InsertHelper</span> <span style="color: #268bd2;">helper</span>=<span style="color: #859900;">new</span> <span style="color: #b58900;">InsertHelper</span>(db, <span style="color: #2aa198;">"test"</span>);
    <span style="color: #b58900;">ContentValues</span> <span style="color: #268bd2;">values</span>=<span style="color: #859900;">new</span> <span style="color: #b58900;">ContentValues</span>();
    values.put(<span style="color: #2aa198;">"name"</span>, <span style="color: #2aa198;">"test"</span>);
    values.put(<span style="color: #2aa198;">"count"</span>, 3);
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">commit_time</span>=0;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">exec_time</span>=0;
    <span style="color: #859900;">for</span> (<span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span> = 0; i &lt; 10; i++) {
        <span style="color: #b58900;">long</span> <span style="color: #268bd2;">time1</span>=System.currentTimeMillis();
        db.beginTransaction();
        <span style="color: #859900;">for</span> (<span style="color: #b58900;">int</span> <span style="color: #268bd2;">j</span> = 0; j &lt; 10000; j++) {
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">execSQL test</span>
            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">db.execSQL("insert into test values (\"test\",2)");</span>

            <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">InsertHelper</span>
            helper.insert(values);
        }
        db.setTransactionSuccessful();
        <span style="color: #b58900;">long</span> <span style="color: #268bd2;">time2</span>=System.currentTimeMillis();
        db.endTransaction();
        <span style="color: #b58900;">long</span> <span style="color: #268bd2;">time3</span>=System.currentTimeMillis();

        exec_time+=(time2-time1);
        commit_time+=(time3-time2);
    }
    <span style="color: #b58900;">long</span> <span style="color: #268bd2;">endTime</span>=System.currentTimeMillis();
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"done: all_time: "</span>+(endTime-startTime)+<span style="color: #2aa198;">"mss avg_exec_time: "</span>+exec_time/10 +<span style="color: #2aa198;">"ms "</span>+<span style="color: #2aa198;">" avg_commit_time: "</span>+commit_time/10+<span style="color: #2aa198;">"ms"</span>);

}
</pre>
</div>

<ul class="org-ul">
<li>c 测试程序
</li>
</ul>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #cb4b16;">#include</span> <span style="color: #2aa198;">"sqlite3.h"</span>
<span style="color: #cb4b16;">#include</span> <span style="color: #2aa198;">&lt;pthread.h&gt;</span>

<span style="color: #b58900;">void</span> <span style="color: #268bd2;">insert</span>(<span style="color: #b58900;">sqlite3</span> * <span style="color: #268bd2;">db</span>) {
    <span style="color: #b58900;">char</span> * <span style="color: #268bd2;">zerr</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">rc</span>=0;
    rc=sqlite3_exec(db,<span style="color: #2aa198;">"pragma synchronous=full;"</span>,0,0,&amp;zerr);

    <span style="color: #859900;">struct</span> <span style="color: #b58900;">timeval</span> <span style="color: #268bd2;">tv</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">begin</span>=0;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">end</span>=0;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">exec_time</span>=0;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">commit_time</span>=0;

    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">j</span>=0;

    gettimeofday(&amp;tv,<span style="color: #2aa198;">NULL</span>);
    begin=tv.tv_sec*1000+tv.tv_usec/1000;

    <span style="color: #859900;">for</span> (j=0; j&lt;10; j++) {
        gettimeofday(&amp;tv,<span style="color: #2aa198;">NULL</span>);
        <span style="color: #b58900;">int</span> <span style="color: #268bd2;">time1</span>=tv.tv_sec*1000+tv.tv_usec/1000;

        rc=sqlite3_exec(db,<span style="color: #2aa198;">"begin transaction"</span>,0,0,&amp;zerr);
        <span style="color: #b58900;">char</span> * <span style="color: #268bd2;">sql</span>=<span style="color: #2aa198;">"insert into test values (?1, ?2)"</span>;
        <span style="color: #b58900;">sqlite3_stmt</span> *<span style="color: #268bd2;">stmt</span>;
        <span style="color: #859900;">const</span> <span style="color: #b58900;">char</span> * <span style="color: #268bd2;">tail</span>;
        rc=sqlite3_prepare_v2(db, sql, strlen(sql), &amp;stmt,&amp;tail);
        <span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span>=0;
        <span style="color: #859900;">for</span> (i = 0; i &lt; 10000; ++i) {
            sqlite3_bind_text(stmt, 1, <span style="color: #2aa198;">"test"</span>, strlen(<span style="color: #2aa198;">"text"</span>), SQLITE_TRANSIENT);
            sqlite3_bind_int(stmt, 2,1);
            sqlite3_step(stmt);
            sqlite3_reset(stmt);
        }
        gettimeofday(&amp;tv,<span style="color: #2aa198;">NULL</span>);
        <span style="color: #b58900;">int</span> <span style="color: #268bd2;">time2</span>=tv.tv_sec*1000+tv.tv_usec/1000;

        rc=sqlite3_exec(db,<span style="color: #2aa198;">"end transaction"</span>,0,0,&amp;zerr);

        gettimeofday(&amp;tv,<span style="color: #2aa198;">NULL</span>);
        <span style="color: #b58900;">int</span> <span style="color: #268bd2;">time3</span>=tv.tv_sec*1000+tv.tv_usec/1000;
        sqlite3_finalize(stmt);
        exec_time+=(time2-time1);
        commit_time+=(time3-time2);
    }
    gettimeofday(&amp;tv,<span style="color: #2aa198;">NULL</span>);
    end=tv.tv_sec*1000+tv.tv_usec/1000;

    printf(<span style="color: #2aa198;">"done: total_time: %d ms, avg_exec_time: %d ms, avg_commit_time: %d ms\n"</span>, end-begin, exec_time/10, commit_time/10);
}


<span style="color: #b58900;">int</span> <span style="color: #268bd2;">main</span>(<span style="color: #b58900;">int</span> <span style="color: #268bd2;">argc</span>, <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">argv</span>[]) {
    <span style="color: #b58900;">sqlite3</span> *<span style="color: #268bd2;">db</span>;
    sqlite3_open_v2(<span style="color: #2aa198;">"/data/test.db"</span>, &amp;db, SQLITE_OPEN_READWRITE, 0);

    <span style="color: #b58900;">pthread_t</span> <span style="color: #268bd2;">tid</span>;
    pthread_create(&amp;tid, <span style="color: #2aa198;">NULL</span>, insert, db);
    pthread_join(tid, <span style="color: #2aa198;">NULL</span>);

    <span style="color: #859900;">return</span> 0;
}
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">synchronous</th>
<th scope="col" class="left">storage</th>
<th scope="col" class="left">method</th>
<th scope="col" class="right">total<sub>time</sub> (ms)</th>
<th scope="col" class="right">avg<sub>exec</sub><sub>time</sub> (ms)</th>
<th scope="col" class="right">avg<sub>commit</sub><sub>time</sub> (ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">off</td>
<td class="left">sd</td>
<td class="left">c</td>
<td class="right">2002</td>
<td class="right">172</td>
<td class="right">27</td>
</tr>

<tr>
<td class="left">off</td>
<td class="left">mtd</td>
<td class="left">c</td>
<td class="right">1888</td>
<td class="right">163</td>
<td class="right">25</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">full</td>
<td class="left">sd</td>
<td class="left">c</td>
<td class="right">3641</td>
<td class="right">165</td>
<td class="right">198</td>
</tr>

<tr>
<td class="left">full</td>
<td class="left">mtd</td>
<td class="left">c</td>
<td class="right">1913</td>
<td class="right">158</td>
<td class="right">31</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">full</td>
<td class="left">ssd</td>
<td class="left">c</td>
<td class="right">450</td>
<td class="right">19</td>
<td class="right">25</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">off</td>
<td class="left">sd</td>
<td class="left">java/execSQL</td>
<td class="right">12996</td>
<td class="right">1269</td>
<td class="right">29</td>
</tr>

<tr>
<td class="left">off</td>
<td class="left">sd</td>
<td class="left">java/insertHelper</td>
<td class="right">10458</td>
<td class="right">1029</td>
<td class="right">16</td>
</tr>

<tr>
<td class="left">off</td>
<td class="left">mtd</td>
<td class="left">java/insertHelper</td>
<td class="right">10067</td>
<td class="right">977</td>
<td class="right">29</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">full</td>
<td class="left">sd</td>
<td class="left">java/execSQL</td>
<td class="right">15385</td>
<td class="right">1252</td>
<td class="right">285</td>
</tr>

<tr>
<td class="left">full</td>
<td class="left">sd</td>
<td class="left">java/insertHelper</td>
<td class="right">11874</td>
<td class="right">987</td>
<td class="right">199</td>
</tr>

<tr>
<td class="left">full</td>
<td class="left">mtd</td>
<td class="left">java/insertHelper</td>
<td class="right">9948</td>
<td class="right">963</td>
<td class="right">31</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>总结
<ul class="org-ul">
<li>使用 java  api 测试时, 执行 sql 语句的速度
比 c 程序慢 7 倍左右
</li>
<li>insertHelper 比普通的 execSQL 有 20% 的提升
</li>
<li>java api 和 c api 在 commit 时间上没有差别
</li>
<li>在 sd 卡上, synchronous off 有近10倍的性能提长<sup><a id="fnr.3" name="fnr.3" class="footref" href="#fn.3">3</a></sup>
</li>
<li>在 mtd 上, synchronous 似乎没有差别.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> Other</h3>
<div class="outline-text-3" id="text-1-5">
</div><div id="outline-container-sec-1-5-1" class="outline-4">
<h4 id="sec-1-5-1"><span class="section-number-4">1.5.1</span> WAL</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
Write Ahead Logging (WAL) 是与 sqlite 默认的 rollback journal (或
delete journal, shadow paging) 完全不同的一种 journal mode. 通过 WAL,
数据库可以做到读和写互相完全不干扰, 并且减少 IO 操作.
</p>
</div>

<div id="outline-container-sec-1-5-1-1" class="outline-5">
<h5 id="sec-1-5-1-1"><span class="section-number-5">1.5.1.1</span> How WAL works</h5>
<div class="outline-text-5" id="text-1-5-1-1">
<p>
当 commit 一个 write transaction 时, rollback journal 的作法是先刷新所
有修改到 journal, 然后再刷新 cache 到数据库. 而 WAL 的作法是只将修
改刷新到 wal journal 中, 而不修改数据库. 只有当用户调用 pragma
wal<sub>checkpoint</sub> 或 超过 1000 页被修改时, wal journal 中的修改才会
被写回到数据库.
</p>

<p>
为了使 read transaction 能读到最新的数据, 每个 read transaction 开始时
会扫描 wal journal, 并在 wal file 中记下一个 mark point, 在读数据库时,
根据一个 wal index shm 判断要读的 page 是否在 wal journal 中, 若存在,
并且不超过 mark point, 则使用 wal journal 中的数据, 否则使用数据库中的
数据. 这样可以使得读写不用互相等待. (但这样有一点问题, 就是无法保证读到
最新的数据, 因为有可能在读的过程中, 又有新的数据追加到 wal journal
file 中 makr point 之后)
</p>
</div>

<ol class="org-ol"><li>WAL 的优点<br  /><div class="outline-text-6" id="text-1-5-1-1-1">
<ul class="org-ul">
<li>读写互不影响
</li>
<li>降低了IO的使用

<p>
commit 只需要写 wal journal file, 不需要写数据库. 特别的, 若 WAL 模式
下设置 pragma synchronous 为 NORMAL 的话,则 commit 根本不会导致 IO 操
作,只有 checkpoint 才会.  因此, 在 wal 模式下, commit 不进行 IO 可能
会导致异常重启后数据丢失, 但不会造成数据库崩溃.
</p>

<p>
checkpoint 进行的 IO 操作包括:
</p>
<ol class="org-ol">
<li>写 wal 到磁盘
</li>
<li>写 wal 到数据库
</li>
<li>重置 wal
</li>
</ol>
</li>
</ul>
</div>
</li>
<li>WAL 的缺点<br  /><div class="outline-text-6" id="text-1-5-1-1-2">
<ul class="org-ul">
<li>可能无法读到"最新"的数据, 因为 read transaction 无法 block write
transaction
</li>
<li>过大的 read transaction 会阻止 checkpoint (当 read transaction 正在进
行时, 虽然允许 write transaction 追加数据到 wal journal, 但不允许清空,
因为 read transaction 已经在journal 中标记了 mark point), 进而导致
wal journal 过大, 从而使 read transaction 变慢
</li>
</ul>
</div>
</li>
<li>WAL 的配置<br  /><div class="outline-text-6" id="text-1-5-1-1-3">
<ul class="org-ul">
<li>pragma journal<sub>mode</sub>=wal 开启 wal 模式
</li>
<li>pragma journal<sub>mode</sub>=delete 关闭 wal 模式
</li>
<li>wal 模式的配置是 persistent 的
</li>
<li>pragma wal<sub>autocheckpoint</sub>=1000 设置 autocheckpoint 的 thresh-hold
特别的, 这个值越大, 则写的性能越高, 这个值越小, 则读的性能越好.
</li>
</ul>
</div>
</li></ol>
</div>
<div id="outline-container-sec-1-5-1-2" class="outline-5">
<h5 id="sec-1-5-1-2"><span class="section-number-5">1.5.1.2</span> 关于 WAL journal file 的一个实验</h5>
<div class="outline-text-5" id="text-1-5-1-2">
<div class="org-src-container">

<pre class="src src-sql"><span style="color: #586e75; font-style: italic;">-- these are auto-committed</span>
insert into test values ("a", 1);
insert into test values ("a", 1);
insert into test values ("a", 1);
<span style="color: #586e75; font-style: italic;">-- &#29616;&#22312;, &#35760;&#24405;&#24212;&#35813;&#23384;&#22312; test.db-wal &#20013;, &#20294;&#36824;&#27809;&#26377;&#20889;&#21040;&#25968;&#25454;&#24211;&#20013;</span>
<span style="color: #586e75; font-style: italic;">-- case A: &#19981;&#35843;&#29992; pragma wal_checkpoint</span>
  <span style="color: #586e75; font-style: italic;">-- kill sqlite3_process</span>
  <span style="color: #586e75; font-style: italic;">-- case A1: &#20808;&#21024;&#38500; test.db-wal, &#20877;&#25171;&#24320; test.db</span>
    select count(*) from test where name="a";
    0
  <span style="color: #586e75; font-style: italic;">-- case A2: &#19981;&#21024;&#38500; test.db-wal, &#25214;&#24320; test.db</span>
    select count(*) from test where name="a";
    3
<span style="color: #586e75; font-style: italic;">-- case B: &#35843;&#29992; pragma wal_checkpoint</span>
  <span style="color: #586e75; font-style: italic;">-- kill sqlite3_process</span>
  <span style="color: #586e75; font-style: italic;">-- &#26080;&#35770;&#26159;&#21542;&#21024;&#38500; test.db-wal, &#25171;&#24320; test.db</span>
    select count(*) from test where name="a";
    3
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-1-5-2" class="outline-4">
<h4 id="sec-1-5-2"><span class="section-number-4">1.5.2</span> FTS</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
FTS (Full Text Search), 即全文检索,主要有以下几个方面:
</p>

<ul class="org-ul">
<li>stemming (词根)
</li>
<li>tokenizer &amp;  word segregation (分词)
</li>
<li>inverted index (倒排索引)
</li>
</ul>
</div>

<div id="outline-container-sec-1-5-2-1" class="outline-5">
<h5 id="sec-1-5-2-1"><span class="section-number-5">1.5.2.1</span> stemming</h5>
<div class="outline-text-5" id="text-1-5-2-1">
<p>
<a href="http://en.wikipedia.org/wiki/Stemming">http://en.wikipedia.org/wiki/Stemming</a>
</p>

<p>
A stemmer for English, for example, should identify the string "cats" (and
possibly "catlike", "catty" etc.) as based on the root "cat".and "stemmer",
"stemming", "stemmed" as based on "stem".
</p>

<p>
A stemming algorithm reduces the words "fishing", "fished", "fish", and "fisher"
to the root word, "fish". On the other hand, "argue", "argued", "argues",
"arguing", and "argus" reduce to the stem "argu"
</p>

<p>
android contacts provider 就是使用的一种叫做 porter 的 stemmer 算法, 所以用 cat
可以查找到名为 catty 的人也是正常的.
</p>
</div>
</div>

<div id="outline-container-sec-1-5-2-2" class="outline-5">
<h5 id="sec-1-5-2-2"><span class="section-number-5">1.5.2.2</span> tokenizer and word segregation (分词)</h5>
<div class="outline-text-5" id="text-1-5-2-2">
<p>
全文检索是基于`关键字`匹配的检索, 与传统的 grep 等检索方法不同, 全文检索需要先建
立索引文件, 建立索引文件的第一步就是将全文分解为一系列的关键字. 例如:
</p>

<p>
"A stemmer for English, for example, should identify the string "cats" (and
possibly "catlike", "catty" etc.) as based on the root "cat""
</p>

<p>
这句话可能会被分解为以下的关键字:
</p>

<p>
stem, english, example, identify, string, cat, possible, base, root
</p>

<p>
tokenize 的过程主要分为三步:
</p>
<ol class="org-ol">
<li>分词, 对英文来说, 基本就是以空格来分词
</li>
<li>抛弃一些 stop words, 如 a, for, should, and ,etc, as, on 等
</li>
<li>对剩下的非 stop words 使用 stemming 算法, 例如 cats-&gt;cat, stemmer-&gt;stem
</li>
</ol>
</div>

<ol class="org-ol"><li>分词<br  /><div class="outline-text-6" id="text-1-5-2-2-1">
<p>
英文分词比较简单,就是以空格来分词, 对于中文或其他一些语言就麻烦的多, 以中文为例,
主要有以下几种分词方法:
</p>

<ol class="org-ol">
<li>N元分词
就是简单的每N个字算一个词,
<ul class="org-ul">
<li>1元分词:
</li>
</ul>
<p>
英/文/分/词/比/较/简/单
</p>

<ul class="org-ul">
<li>2元交叉为例:
</li>
</ul>
<p>
英文/文分/分词/词比/比较/较简/简单
</p>
</li>

<li>基于词典匹配的分词
<ul class="org-ul">
<li>正向最大匹配
"市场/中国/有/企业/才能/发展"
</li>
<li>逆向最大匹配
"市场/中/国有/企业/才能/发展"
</li>
<li>双向最大匹配
</li>
</ul>
</li>
<li>基于统计的分词
</li>
</ol>


<p>
从目前存在的项目看, 综合N元分词与基于词典匹配的分词是主流的方法, 以 Apache
Lucene 为例: 它包含以下几种中文分词算法:
<a href="http://blog.csdn.net/chaocy/article/details/5938741">http://blog.csdn.net/chaocy/article/details/5938741</a>
</p>

<ul class="org-ul">
<li>StandardAnalyzer &amp; ChineseAnalyzer (一元分词)
</li>
</ul>

<p>
2008/年/8/月/8/日/晚/举/世/瞩/目/的/北/京/第/二/十/九/届/奥/林/匹/克/运/动/会/开
/幕/式/在/国/家/体/育/场/隆/重/举/行
</p>

<ul class="org-ul">
<li>CJKAnalyzer (交叉二元分词)
</li>
</ul>

<p>
2008/年/8/月/8/日晚/举世/世瞩/瞩目/目的/的北/北京/京第/第二/二十/十九/九届/届奥/
奥林/林匹/匹克/克运/运动/动会/会开/开幕/幕式/式在/在国/国家/家体/体育/育场/场隆/
隆重/重举/举行/
</p>

<ul class="org-ul">
<li>MIK<sub>CAnalyzer</sub>  (最大匹配+二元交叉)
</li>
</ul>

<p>
2008年/8月/8日/晚/举世瞩目/目的/北京/第二十九届/奥林匹克运动会/开
幕式/在国/国家/体育场/隆重举行/
</p>

<ul class="org-ul">
<li>etc
</li>
</ul>

<p>
sqlite3 中因为支持 FTS, 所以也支持几种分词算法:
</p>
<ul class="org-ul">
<li>simple
针对英文, 根据空格分词
</li>
<li>porter
针对英文, 使用 port stemmer
</li>
<li>icu
使用 icu 库进行简单分词, 没有看懂 fts<sub>icu</sub> 的源码, 从分词结果看类似于一元分词
(待确定)
</li>
</ul>
</div>
</li></ol>
</div>
<div id="outline-container-sec-1-5-2-3" class="outline-5">
<h5 id="sec-1-5-2-3"><span class="section-number-5">1.5.2.3</span> inverted index (倒排索引)</h5>
<div class="outline-text-5" id="text-1-5-2-3">
<p>
通过分词算法确定关键词后, FTS 会使用倒排索引建立索引, 例如全文有两句话:
</p>

<p>
`今天天气怎么样.
今天天气不错. `
</p>

<ul class="org-ul">
<li>分词的结果

<p>
今天/天气/怎么样/今天/天气/不错
</p>
</li>

<li>倒排索引结果

<p>
今天-&gt;1,0;2,0
天气-&gt;1,2;2,2
怎么样-&gt;1,4
不错-&gt;2,4
</p>
</li>
</ul>

<p>
倒排索引的结果通常会以一种高效的利于查找的形式保存到索引文件中, 例如根据关键字排
序, 或使用 B 树
</p>
</div>
</div>

<div id="outline-container-sec-1-5-2-4" class="outline-5">
<h5 id="sec-1-5-2-4"><span class="section-number-5">1.5.2.4</span> 查找过程</h5>
<div class="outline-text-5" id="text-1-5-2-4">
<p>
根据索引文件格式的不同, 查找的过程有所区别, 以 B 树为例, 查找过程就是以查找字符
串为KEY在B树中查找该关键字,查到的VALUE就是该关键字在文档中的行列位置.
</p>

<p>
全文查找速度很快,但有一个明显的缺点: 检索的效果依赖于关键字的选择.
</p>

<p>
例如,
</p>
<ul class="org-ul">
<li>使用 "tty" 无法检索到 " hello kitty "这句话
</li>
<li>使用 "天天" 可能无法检索到 "今天天气不错"
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-5-2-5" class="outline-5">
<h5 id="sec-1-5-2-5"><span class="section-number-5">1.5.2.5</span> FTS in sqlite3</h5>
<div class="outline-text-5" id="text-1-5-2-5">
<ul class="org-ul">
<li>create virtual table search<sub>index</sub> using fts3(content TEXT, tokenize=porter);
tokenize 可以为 simple, porter, icu, 但默认情况下 icu tokenizer 功能没有被编译
到 sqlite3 中
</li>
<li>select * from search<sub>index</sub> where content match "token1 token2"
</li>
<li>select * from search<sub>index</sub> where content match "tok*"
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-1-5-3" class="outline-4">
<h4 id="sec-1-5-3"><span class="section-number-4">1.5.3</span> SQLite Optimization FAQ</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
<a href="http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html">http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html</a>
</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
because A is holding a `shared` lock
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
because B is holding a `reserved` lock
</p></div>

<div class="footdef"><sup><a id="fn.3" name="fn.3" class="footnum" href="#fnr.3">3</a></sup> <p class="footpara">
具体的情况应该取决于: 1. page cache 的大小 2. 生产者(sql 程序)
与消费者(io) 的处理数据的速度的差
</p></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: wei.sun</p>
<p class="email">Email: <a href="mailto:wei.sun@spreadtrum.com">wei.sun@spreadtrum.com</a></p>
<p class="date">Created: 2014-01-30 Thu 13:54</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.5g)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
