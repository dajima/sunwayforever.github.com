<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Java Hashcode</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Java Hashcode"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-05-17T17:00+0800"/>
<meta name="author" content="sunway"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>    <link rel="stylesheet" type="text/css" href="stylesheets/main.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Java Hashcode</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Object.hashCode()</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Object.hashCode()</h2>
<div class="outline-text-2" id="text-1">

<p>   <span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED: </span> <span class="timestamp">2011-09-12 一 14:46</span></span><br/>
    众所周知, Object.hashCode()和对象的地址有很大关系,而某些GC算法(如Copying, mark-sweep-compact&hellip;)会改变对象的地址,而hashCode是要保证对同一个对象永远不变 (否则HashMap会很崩溃),那么hashCode如何保证对
    不同的对象 <b>尽可能</b> 的不同, 而对于同一个对象一定保持不变? 
</p>
<p>
    不同的jvm在处理Object.hashCode()有不同的方法,但基本原理是相同的:
</p>
<p>
    <b>若对象没移动过,则返回对象的地址做为hashCode；对象移动时,若发现hashCode已经被调用过了,为了使后续对该对象的hashCode仍返回相同的值,保存该hashCode (即对象移动之前的地址)</b>
</p>
<ul>
<li>Hotspot JVM:
      Hotspot JVM中一个对象在内存中的layout大致是:

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<tbody>
<tr><td class="left">Mark Word</td><td class="left">Object</td><td class="left">Padding</td></tr>
</tbody>
</table>


<ul>
<li>Mark Word:
        HashCode, lock, thread<sub>id</sub> 等都保存在 Mark Word中
</li>
<li>Object: 
        真正的对象
</li>
<li>Padding:
        JVMS规定需要8字节对齐

</li>
</ul>

<p>      OpenJdk是关于HashCode的代码:
</p></li>
</ul>


<pre lang="java" line="1">
      mark=ReadStableMark(obj);
      if (mark->is_neutral()) {
        hash=mark->hash();
        if (hash) {
          return hash;
        }
        hash=get_next_hash(Self,obj);
        temp=mark->copy_set_hash(hash);
test=cmpxchg(temp,obj->mark_addr(),mark); // 使用CAS保证操作是原子的
        if (test==mark) {
          return hash;
        }
      }
      ...
</pre>
<ul>
<li>Dalvik VM

<p>      
      Dalvik与Hotspot类似, 不过它把HashCode保存在真正的对象数据之后 
</p>
<p>
      dalvik/vm/Sync.c:dvmIdentityHashCode
</p></li>
</ul>


<pre lang="java" line="1">
      if (hashState == LW_HASH_STATE_HASHED) {
         // The object has been hashed but has not had its hash code
         // relocated by the garbage collector.  Use the raw object
         // address.
        return (u4)obj >> 3; // >>3 means 8 bytes alligned
      } else if (hashState == LW_HASH_STATE_HASHED_AND_MOVED) {
         // The object has been hashed and its hash code has been
         // relocated by the collector.  Use the value of the naturally
         // aligned word following the instance data.
        if (IS_CLASS_FLAG_SET(obj->clazz, CLASS_ISARRAY)) {
            length = arrayObjectLength((ArrayObject *)obj);
            length = (length + 3) & ~3;
        } else {
            length = obj->clazz->objectSize;
        }
        return *(u4 *)(((char *)obj) + length);
      } else if (hashState == LW_HASH_STATE_UNHASHED) {
        self = dvmThreadSelf();
        if (self->threadId == lockOwner(obj)) {
             // We already own the lock so we can update the hash state
             // directly.
            *lw |= (LW_HASH_STATE_HASHED << LW_HASH_STATE_SHIFT);
            return (u4)obj >> 3;
        } 
        ...
      }
</pre>

<p>    
    dalvik vm 中导致对象地址变化的GC部分代码:
</p>
<p>    
    android:vm/alloc/Copying.c:transportObject(fromObj)
<pre lang="java" line="1">
    if (LW_HASH_STATE(fromObj->lock)==LW_HASH_STATE_HASHED_AND_MOVED) {
      copySize+=sizeof(u4); // make sure the hashCode at the `END` of the obj is also copied.
    }
    if (LW_HASH_STATE(fromObj->lock)==LW_HASH_STATE_HASHED) {
      // save the raw address to the END of obj, >>3 means 8 bytes alligned     
      *(u4*)(((char *)toObj)+copySize)=(u4)fromObj>>3;  
      toObj->lock|=LW_HASH_STATE_HASHED_AND_MOVED<<LW_HASH_STATE_SHIFT;
    }
    ..
</pre>
    考虑这种情况:
</p>
<p>
    obj1初始时(GC之前)被放在addr1, 然后用户调用obj1.hashCode(), 然后obj1因为GC被移动到addr3;
    然后obj2刚好被在初始化到addr1 (因为这个地址已经是空闲的了), 这对用户调用obj2.hashCode(), 
    最终导致obj1.hashCode()==obj2.hashCode(); 虽然这种情况不是我们想要的, 但hash算法本身决定了这种情况上是允许的
</p>


</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-05-17T17:00+0800</p>
<p class="author">Author: sunway</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.1 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 23</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
