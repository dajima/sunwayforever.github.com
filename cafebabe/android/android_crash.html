<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>How Android Is Crashed</title>
<!-- 2014-01-30 Thu 13:54 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="wei.sun" />
<link rel="stylesheet" type="text/css" href="/stylesheets/main.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">How Android Is Crashed</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Android Crash</a>
<ul>
<li><a href="#sec-1-1">1.1. Android Process Crash, Die and Restart</a></li>
<li><a href="#sec-1-2">1.2. How to Restart On Crash?</a></li>
<li><a href="#sec-1-3">1.3. misc.</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Android Crash</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Android Process Crash, Die and Restart</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>State "TODO"       from "DONE"       <span class="timestamp-wrapper"><span class="timestamp">[2012-12-20 Thu 13:57]</span></span>
</li>
<li>State "DONE"       from "DOING"      <span class="timestamp-wrapper"><span class="timestamp">[2011-07-18 Mon 14:39]</span></span>
see also <i>persistent application</i>
see also <i>STICKY service</i>
see also <i>Java Process Creation</i>
see also <i>binder's death</i>
Note: we can also restart process manually by: AM.restartPackage()
</li>
</ul>
</div>
<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1"><span class="section-number-4">1.1.1</span> APP crash: process crashed because of UncaughtException</h4>
<div class="outline-text-4" id="text-1-1-1">
<ol class="org-ol">
<li>setDefaultUncaughtExceptionHandler during process creation
</li>
</ol>
<pre class="example">
1	    Thread.setDefaultUncaughtExceptionHandler @ RuntimeInit.java
2	      UncaughtHandler implements Thread.UncaughtExceptionHandler
3	        public void uncaughtException(Thread t, Throwable e):
4		  ActivityManagerNative.getDefault().handleApplicationCrash(mApplicationObject, new ApplicationErrorReport.CrashInfo(e));
5		  Process.killProcess(Process.myPid());
6	          System.exit(10);
</pre>
<ol class="org-ol">
<li>when there are ANY uncaught exception in ANY thread, AMS.handleApplicationCrash will be invoked, and then process will be killed
</li>
</ol>
<pre class="example">
 1	      AMS.handleApplicationCrash()
 2	        crashApplication(r, crashInfo);
 3	          makeAppCrashingLocked()
 4	            handleAppCrashLocked(app);
 5	              // NOTE: when handling app crashing, the process is still alive, so there is still a chance for AMS to stop activity/service(s)..
 6	              // if crashing too much, stopActivity, and in SOME cases, bringDownService
 7	              if (crashTime != null &amp;&amp; now &lt; crashTime+MIN_CRASH_INTERVAL):
 8	                killServicesLocked(app, false);
 9	                // `killServiceLocked`, the name is quite misleading, maybe it should be named to `killOrRestartService`xs
10	                foreach (activity of app):
11	                  finishActivityLock();
12	              // although crashTime interval is long enough, but if the crashed app owns the top running activity...also finish the activities
13	              ...
14	              foreach (service of app):
15	                service.crashCount++;
16	      // NOTE: any way, after handleApplicationCrash, the process will definitely be killed. But before it is killed, AMS can destroy the activity/service
17	      // explicitly, and what's more important, restart service in some cases;
</pre>
<ol class="org-ol">
<li>Process.killProcess
After handleApplicationCrash(), the process will be killed

<p>
When process exit, all fd(s) will be closed; when the fd of /dev/binder is closed, binder<sub>release</sub>() in binder.c will be called;
binder<sub>release</sub> will trigger the binder<sub>death</sub> notification of the IApplicationThread binder node;
For each Java process, AMS hold their IApplicationThread, in app.thread. Thus, when the process exit, AMS.AppDeathRecipient (which implements
IBinder.DeathRecipient) will be notified.
</p>

<p>
AppDeathRecipient mainly does some cleaning up of activity/service, but if the app is persistent, it will always be restarted
</p>
</li>
</ol>
<pre class="example">
AppDeathRecipient.binderDie()
  ...
  cleanUpApplicationRecordLocked()
    if (app.persistent):
      startProcessLocked(app, "restart", app.processName);
</pre>

<ol class="org-ol">
<li>AMS.killServiceLocked
</li>
</ol>
<pre class="example">
if (service.crashCount &gt;= 2):
  bringDownServiceLocked(sr, true);
else:
  scheduleServiceRestartLocked(sr, true);
  // after 5s, service will be restarted
  // sr.stopIfKill is true if the service is started as STICKY
  if (sr.stopIfKilled):
    if (!hasClients):
      // Whoops, no reason to restart! since no one bind the service
      bringDownServiceLocked(sr, true);
</pre>
<p>
To summaries: After an uncaught exception occurs in any thread, the process
  will crash through the registered Thread.UncaughtExceptionHandler. The
  handler will firstly finish activities, and if the service has crashed &gt;=2
  times, the service will be bringDown (service.onDestroy will be called) If
  the service is crashing for the 1st time, doesn't bring it down
  (service.onDestroy will not be called, although the service will be killed
  due to the process will be killed later), and schedule the restart of the
  service after the process is killed later.
</p>
</div>
</div>
<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2"><span class="section-number-4">1.1.2</span> APP die: process crashed because of KILL</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
when process is killed, AMS mainly rely on DeathRecipient to clean it up or
restart it.
</p>

<pre class="example">
DeathRecipient:
  appDiedLocked(mApp, mPid, mAppThread);
    handleAppDiedLocked()
      cleanUpApplicationRecordLocked(app, restarting, allowRestart, -1);
        killServicesLocked(app, allowRestart);
          if (sr.crashCount &gt;= 2 &amp;&amp; (sr.serviceInfo.applicationInfo.flags
                  &amp;ApplicationInfo.FLAG_PERSISTENT) == 0) {
              bringDownServiceLocked(sr, true);
          } else if (!allowRestart) {
              bringDownServiceLocked(sr, true);
          } else {
              boolean canceled = scheduleServiceRestartLocked(sr, true);
              if (sr.stopIfKilled) {
                // NOTE: stopIfKilled means not STICKY
                bringDownServiceLocked(sr, true);
              }
          }
        if (app.persistent) {
          startProcessLocked(app, "restart", app.processName);
        }
</pre>
<p>
To summarize:
</p>

<p>
Died app will be restarted if:
</p>
<ul class="org-ul">
<li>has STICKY service
</li>
<li>is persistent ** Alarm
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> How to Restart On Crash?</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> PERSIST application</h4>
</div>
<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> STICKY Service</h4>
</div>
<div id="outline-container-sec-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><span class="section-number-4">1.2.3</span> Using two process to monitor each other?</h4>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> misc.</h3>
<div class="outline-text-3" id="text-1-3">
</div><div id="outline-container-sec-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> how to clear Notification on crash?</h4>
<div class="outline-text-4" id="text-1-3-1">
<ol class="org-ol">
<li>startForeground
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: wei.sun</p>
<p class="email">Email: <a href="mailto:wei.sun@spreadtrum.com">wei.sun@spreadtrum.com</a></p>
<p class="date">Created: 2014-01-30 Thu 13:54</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.5g)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
