<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Android Save State</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Android Save State"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-05-17T17:03+0800"/>
<meta name="author" content="sunway"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Android Save State</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Android Save State howto</a>
<ul>
<li><a href="#sec-1-1">1.1 Activity.onSaveInstanceState</a></li>
<li><a href="#sec-1-2">1.2 To summarizes</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Android Save State howto</h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Activity.onSaveInstanceState</h3>
<div class="outline-text-3" id="text-1-1">

<p>When system thinks that an activity need to be `saved` before destroying it,
`onSaveInstanceState` will be invoked. But, when should the activity be
`saved`?  It depends &hellip; but in one word, if the activity may be destroyed
without the users notification, it's state will be `saved`, e.g.:
</p><ul>
<li>orientation change
</li>
<li>background activity is killed to reserve resource
</li>
<li>&hellip;
</li>
</ul>


<p>
Activity's `instance state` mainly matters 3 aspects:
</p><ol>
<li>view hierarchy
</li>
<li>managed dialog
</li>
<li>fragments
</li>
</ol>


<p>
Note that: there is another kind of `instance state`: NonConfigurationInstances
state, these states are maintained by `onRetainNonConfigurationInstance` and
only matters about configurationChange
</p>



<pre class="src src-fundamental">ActivityThread.performStopActivity
  mInstrumentation.callActivityOnSaveInstanceState(r.activity, state);
    activity.performSaveInstanceState(outState);
      onSaveInstanceState(outState);
      saveManagedDialogs(outState);

Activity.onSaveInstanceState(outState);
  // 1. save view hierarchy
  outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());
  // 2. save fragment
  outState.putParcelable(FRAGMENTS_TAG, mFragments.saveAllState(););

// View hierarchy is made up of 4 elements:
// 1. view hierarchy
// 2. focused view
// 3. panels
// 4. action bar
PhoneWindow.saveHierarchyState()
  SparseArray&lt;Parcelable&gt; states = new SparseArray&lt;Parcelable&gt;();
  // the view root
  mContentParent.saveHierarchyState(states);
    View.dispatchSaveInstanceState(container);
      if (mID != NO_ID &amp;&amp; (mViewFlags &amp; SAVE_DISABLED_MASK) == 0):
        Parcelable state = onSaveInstanceState();
        container.put(mID, state);
  outState.putSparseParcelableArray(VIEWS_TAG, states);
  // save the focused view id
  View focusedView = mContentParent.findFocus();
  outState.putInt(FOCUSED_ID_TAG, focusedView.getId());
  // save the panels state
  ...
  // save action bar state
</pre>

</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> To summarizes</h3>
<div class="outline-text-3" id="text-1-2">

<ol>
<li>When Activity.onSaveInstanceState is invoked? It depends &hellip;
</li>
<li>What is saved during Activity.onSaveInstanceState:
<ul>
<li>managed dialog
</li>
<li>fragments state
</li>
<li>view hierarchy
</li>
</ul>

</li>
<li>when saving view hierarchy, `only a few` views have implemented the
   `onSaveInstanceState`, e.g:

<ul>
<li>TextView
     to save the text
</li>
<li>Spinner
</li>
<li>ListView
</li>
<li>ProgressBar
</li>
<li>&hellip;

</li>
</ul>

<p>   Note that: LayoutParams is never saved by default.
</p>
</li>
<li>The view hierarchy will not be saved properly if two views share the save
   `mID`, because `container.put(mID, state);`, this problem is especially
   important for ViewGroup like ListView (ListView items always have items with
   the same mID), so these ViewGroup must override the
   `dispatchSaveInstanceState` method.
</li>
<li>view with mID==NO<sub>ID</sub>, or with view flag: SAVE<sub>DISABLED</sub><sub>MASK</sub> will not be saved
</li>
</ol>



</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-05-17T17:03+0800</p>
<p class="author">Author: sunway</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.1 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 23</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
