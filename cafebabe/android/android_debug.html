<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Android Debug</title>
<!-- 2014-04-02 Wed 16:33 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/stylesheets/main.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Android Debug</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Android Debug Internals</a>
<ul>
<li><a href="#sec-1-1">1.1. hierachyviewer</a></li>
<li><a href="#sec-1-2">1.2. ddms</a></li>
<li><a href="#sec-1-3">1.3. adb</a></li>
<li><a href="#sec-1-4">1.4. monkey</a></li>
<li><a href="#sec-1-5">1.5. uiautomator</a></li>
<li><a href="#sec-1-6">1.6. tombstone / debuggerd</a></li>
<li><a href="#sec-1-7">1.7. watchdog</a></li>
<li><a href="#sec-1-8">1.8. anr trace</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Android Debug Internals</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> hierachyviewer</h3>
<div class="outline-text-3" id="text-1-1">
<p>
hierachyviewer 在 host 端通过 socket 与手机端的 ViewServer 通信.
ViewServer 并非开机启动, 而是需要由 host 端的 hierachyviewer 的
startViewServer 通过 "adb shell service call window 1 i32 port" 调用
WMS 的 startViewServer 来启动,
</p>

<p>
ViewServer 会负责调用 ViewDebug 的相关方法来 DUMP 或 CAPTURE 等
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> ddms</h3>
<div class="outline-text-3" id="text-1-2">
<p>
ddms 通过 jdwp 控制 java 进程
</p>
</div>
<div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> method tracing</h4>
</div>
<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> hprof</h4>
<div class="outline-text-4" id="text-1-2-2">
<ul class="org-ul">
<li>在代码中生成
Debug.dumpHprofData()
</li>
<li>使用信号on-demand生成
</li>
<li>为了能让MAT识别android的hprof格式,需要用hprof-conv转换一下
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><span class="section-number-4">1.2.3</span> gc</h4>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> adb</h3>
<div class="outline-text-3" id="text-1-3">
<p>
adb 通过 host 上的 adb 与手机端的 adbd 通信
</p>
</div>
<div id="outline-container-sec-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> logcat</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
adb shell setprop log.tag.mytag verbose
</p>
</div>
<div id="outline-container-sec-1-3-1-1" class="outline-5">
<h5 id="sec-1-3-1-1"><span class="section-number-5">1.3.1.1</span> events log</h5>
<div class="outline-text-5" id="text-1-3-1-1">
<ul class="org-ul">
<li>content<sub>query</sub><sub>sample</sub>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><span class="section-number-4">1.3.2</span> logwrapper</h4>
</div>
<div id="outline-container-sec-1-3-3" class="outline-4">
<h4 id="sec-1-3-3"><span class="section-number-4">1.3.3</span> am</h4>
</div>
<div id="outline-container-sec-1-3-4" class="outline-4">
<h4 id="sec-1-3-4"><span class="section-number-4">1.3.4</span> pm</h4>
</div>
<div id="outline-container-sec-1-3-5" class="outline-4">
<h4 id="sec-1-3-5"><span class="section-number-4">1.3.5</span> dumpsys</h4>
</div>
<div id="outline-container-sec-1-3-6" class="outline-4">
<h4 id="sec-1-3-6"><span class="section-number-4">1.3.6</span> input</h4>
</div>
<div id="outline-container-sec-1-3-7" class="outline-4">
<h4 id="sec-1-3-7"><span class="section-number-4">1.3.7</span> procrank</h4>
</div>
<div id="outline-container-sec-1-3-8" class="outline-4">
<h4 id="sec-1-3-8"><span class="section-number-4">1.3.8</span> procmem</h4>
</div>
<div id="outline-container-sec-1-3-9" class="outline-4">
<h4 id="sec-1-3-9"><span class="section-number-4">1.3.9</span> getprop</h4>
</div>
<div id="outline-container-sec-1-3-10" class="outline-4">
<h4 id="sec-1-3-10"><span class="section-number-4">1.3.10</span> dumpstate</h4>
</div>
<div id="outline-container-sec-1-3-11" class="outline-4">
<h4 id="sec-1-3-11"><span class="section-number-4">1.3.11</span> setprop</h4>
</div>
<div id="outline-container-sec-1-3-12" class="outline-4">
<h4 id="sec-1-3-12"><span class="section-number-4">1.3.12</span> service</h4>
<div class="outline-text-4" id="text-1-3-12">
<p>
例如 hierachyviewer 启动 ViewServer 就是使用 "service call window 1
i32 port" 命令
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> monkey</h3>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> uiautomator</h3>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> tombstone / debuggerd</h3>
<div class="outline-text-3" id="text-1-6">
<p>
tombstone 的生成由两方面配合: 
</p>
<ol class="org-ol">
<li>一个 stand-alone 的基于 local socket 的 server: debuggerd.c
</li>
<li>bionic 中通过 linker 嵌入到每一个可执行程序的代码: debugger.c
</li>
</ol>
</div>

<div id="outline-container-sec-1-6-1" class="outline-4">
<h4 id="sec-1-6-1"><span class="section-number-4">1.6.1</span> debuggerd.c</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
debuggerd 由 init 启动, 在一个 local socket 上监听, 每一个进程当收到
SIG<sub>ABORT</sub> 等信号时, 会因为 debugger.c 的原因向 debuggerd.c 发送通知,
debuggerd.c 负责 dump tombstone 文件, dump 完成后向原进程再次发送同样
的信号, 这时进程才真正退出. 
</p>
</div>
</div>
<div id="outline-container-sec-1-6-2" class="outline-4">
<h4 id="sec-1-6-2"><span class="section-number-4">1.6.2</span> debugger.c</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
debugger.c 由 bionic 的 linker 负责嵌入到每一个 elf 文件的 _start 段,
所以每一个进程都会自动执行该代码. 它的作用主要是 catch 住所有会导致退
出的信号, 例如 SIG<sub>ABRT</sub>, SIG<sub>SEGV</sub> 等 (但不包括 SIG<sub>KILL</sub>). 对应的
signal handler 就是向 debuggerd.c 发送消息, 请求 dump tombstone, 同时,
为了收到 debuggerd 再次发送的信号能退出, debugger.c 会把这些信号的
handler 置为 default.
</p>

<p>
因为 SIG<sub>KILL</sub> 无法被 catch, 所以 tombstone 无法处理 java crash, 因为
java crash 是通过 dalvik 向自己发送 SIG<sub>KILL</sub> 实现的.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> watchdog</h3>
</div>
<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> anr trace</h3>
<div class="outline-text-3" id="text-1-8">
</div><div id="outline-container-sec-1-8-1" class="outline-4">
<h4 id="sec-1-8-1"><span class="section-number-4">1.8.1</span> AMS 发送 SIGQUIT (3)</h4>
<div class="outline-text-4" id="text-1-8-1">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #2aa198;">AMS</span>:<span style="color: #b58900;">appNotResponding</span>
  <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">for the pid, or other related pids, send SIG_QUIT (3)</span>
  Process.<span style="color: #268bd2;">sendSignal</span>(<span style="color: #b58900;">pid</span>, <span style="color: #2aa198;">Process</span>.<span style="color: #b58900;">SIGNAL_QUIT</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-8-2" class="outline-4">
<h4 id="sec-1-8-2"><span class="section-number-4">1.8.2</span> SignalCatcher Thread</h4>
<div class="outline-text-4" id="text-1-8-2">
<p>
每个 java 进程初始时会启动一个 SignalCatcher Thread, 用来接收 SIG<sub>QUIT</sub>
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #586e75; font-style: italic;">/* </span><span style="color: #586e75; font-style: italic;">start signal catcher thread that dumps stacks on SIGQUIT */</span>
<span style="color: #859900;">if</span> (<span style="color: #dc322f;">!</span>gDvm.reduceSignals &amp;&amp; <span style="color: #dc322f;">!</span>gDvm.noQuitHandler) {
    <span style="color: #859900;">if</span> (<span style="color: #dc322f;">!</span>dvmSignalCatcherStartup())
        <span style="color: #859900;">return</span> <span style="color: #2aa198;">false</span>;
}
</pre>
</div>

<p>
SIG<sub>QUIT</sub> 的 handler 如下:
</p>

<div class="org-src-container">

<pre class="src src-java">dvmSuspendAllThreads(SUSPEND_FOR_STACK_DUMP);
dvmDumpLoaderStats(<span style="color: #2aa198;">"sig"</span>);
dvmDumpJniStats(&amp;target);
dvmDumpAllThreadsEx(&amp;target, <span style="color: #2aa198;">true</span>);
</pre>
</div>

<p>
参考: dalvik thread suspend
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Wei Sun (孙伟)</p>
<p class="email">Email: <a href="mailto:wei.sun@spreadtrum.com">wei.sun@spreadtrum.com</a></p>
<p class="date">Created: 2014-04-02 Wed 16:33</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.5g)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
