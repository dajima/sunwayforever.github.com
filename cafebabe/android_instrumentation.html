<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Android Instrumentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Android Instrumentation"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-05-17T12:15+0800"/>
<meta name="author" content="sunway"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style><link rel="stylesheet" title="Standard" href="style.css" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Android Instrumentation</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Android Instrumentation</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Android Instrumentation</h2>
<div class="outline-text-2" id="text-1">

<p>   see also <a href="#Android-Testing">@Android Testing</a>
</p>
<p>
   <b>instrumentation n. 测试设备</b>
</p>
<p>
   Instrumentation is the bridge between ActivityThread and Activity (only <b>Activity</b>; Service, broadcast, provider has nothing to do with Instrumentation)
   e.g.
</p>


<pre lang="java" line="1">
   ActivityThread.scheduleLaunchActivity:
     mInstrumentation.newActivity(classLoader, component.getClassName(), r.intent)
       (Activity)cl.loadClass(className).newInstance();
     activity.attach()
     mInstrumentation.callActivityOnCreate(activity, r.state);
     mInstrumentation.callActivityOnStart();
     mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);
     mInstrumentation.callActivityOnPostCreate(activity, r.state);
</pre>

<p>
   Instrumentation.callActivityOnXxx() typically does nothing but call through to activity.onXxx(), e.g.
</p>


<pre lang="java" line="1">
   Instrumentation.callActivityOnStart():
     activity.onStart();
</pre>

<p>
   Instrumentation should not be that simple!
   Actually, as a common rule, `indirect is good &hellip;`, that is, Instrumentation is a hook provided by ActivityThread, so that user can replace the default
   `mInstrumentation` with a user-define Instrumentation instance. with our own `mInstrumentation`, we can track the ActivityThread.
</p>
<ul>
<li>how to inject our own mInstrumentation? (1/2)

<p>
     suppose we want to hook our instrumentation to package `com.sunway.testwebview`:
</p><ol>
<li>implement a class com.x.y/.MyInstrumentation  which extends `Instrumentation`
</li>
<li>in com.x.y/Manifest.xml, add a new `Instrumentation` rule: name=`com.x.y/.MyInstrumentation`, package=`com.sunway.testwebview`
</li>
<li>`adb shell am instrument -w com.x.y/.MyInstrumentation
</li>
</ol>

<p>     now, MyInstrumentation is injected to `com.sunway.testwebview`'s running process.
</p>
</li>
<li>more details of Instrumentation injection (1/2)

<p>
     after com.x.y application is installed, PMS will maintain info about `MyInstrumentation`, e.g. which package the Instrumentation want to be injected to.
</p>
<p>
     `adb shell am instrumentation -w xxx` actually invoke AMS.startInstrumentation():
</p></li>
</ul>




<pre lang="java" line="1">
     startInstrumentation(ComponentName className,...)  ;; className is the Instrumentation's class name, e.g. `com.x.y/.MyInstrumentation`
       ;; PMS maintains the instrumentation's info during installation of `com.x.y`
       ;; and it knows which package the Instrumentation want to hooked to (com.sunway.testwebview)
       ii=mContext.getPackageManager().getInstrumentationInfo(className);
       ai= mContext.getPackageManager().getApplicationInfo(ii.targetPackage,...); ;;ii.targetPackage=`com.sunway.testwebview`
       ;; both package need to be signed with the same signature
       PMS.checkSignatures(ii.targetPackage,ii.packageName)
       ;; find or create target ProcessRecord
       ProcessRecord app = addAppLocked(ai);
         app = getProcessRecordLocked(info.processName, info.uid);
         if app==null:
           app = newProcessRecordLocked(null, info, null);
         if app.thread==null:
           startProcessLocked(app, "added application", app.processName);
       app.instrumentationClass = className; ;; injected!
</pre>

<ul>
<li>how to inject our own mInstrumentation? (2/2)

<p>
     after app.instrumentationClass is set to `com.x.y/.MyInstrumentation`, how is it used?
     app (ProcessRecord) only resides in AMS side, ActivityThread has no knowledge of it.
</p>
<p>
     after `com.sunway.testwebview`'s process is ready, it will invoke attachApplication() to attach with AMS:
</p></li>
</ul>




<pre lang="java" line="1">
     AMS.attachApplication()
       thread.bindApplication(...,app.instrumentationClass,...) ;; AMS call back to ActivityThread
         if instrumentationClass!=null:
           mInstrumentation = (Instrumentation)cl.loadClass(instrumentationClass.getClassName()).newInstance(); ;; AHA!
           mInstrumentation.init(...,appContext,...) ;; set appContext, so that instrumentation can use the context to interact with AMS, e.g. startActivity()
           mInstrumentation.onCreate()
         else:
           mInstrumentation = new Instrumentation();
</pre>

<ul>
<li>sequence graph
</li>
</ul>





<pre class="example">|---------------------------------------+------------------------+---------------------------|
| AMS                                   | PMS                    | ActivityThread            |
|---------------------------------------+------------------------+---------------------------|
| startInstrumentation                  |                        |                           |
|                                       | getInstrumentationInfo |                           |
| startProcessLocked                    |                        |                           |
| remember app.instrumentationClass     |                        |                           |
|                                       |                        | attachApplication         |
| bindApplication(instrumentationClass) |                        |                           |
|                                       |                        | set mInstrumentation      |
|                                       |                        | mInstrumentation.onCreate |
|---------------------------------------+------------------------+---------------------------|
</pre>


<ul>
<li>apart from tracking purpose, Instrumentation also has provided some methods for testing purpose (
     since it running in the same process with the activity, and it has the most import mContext (set by Instrumentation.init() )):
<ul>
<li>Instrumentation.onCreate() is call after startInstrumentation() and before any application component is launched.
</li>
<li>Instrumentation has provided handy methods like sendKeySync, sendPointerSync, &hellip; which simply encapsulated WMS's correspondant (injectKeyEvent &hellip;)
</li>
<li>Activity startActivitySync(), it is implemented similar with context.startActivity(), but this method can wait until activity is created, and
       return the created activity instance.
       (Note: the resolved activity must be in the same process with the Instrumentation, or else Exception will be thrown,
       since Instrumentation can't obtain reference of an inter-process Activity instance)
</li>
</ul>

</li>
</ul>


<p>
   To summarize:
</p><ul>
<li>mInstrumentation is only a hook of ActivityThread, it runs in the same process with the ActivityThread.
</li>
<li>AMS.startInstrumentation will start the Instrumentation's hooked application automatically.
</li>
<li>Instrumentation has provided additional methods for testing purpose, and these method can interact with AMS using Instrumentation.getContext()
</li>
</ul>

<p>   <b>Above all</b>:
</p><ol>
<li>Instrumentation has the mContext, and is set by AMS automatically, so that it can interact with AMS, e.g. Instrumentation.startActivitySync()
</li>
<li>Instrumentation provides another way to start java process in android, and it has provided the Instrumentation.onCreate() hook,
        this ability is especially valuable for testing purpose.
</li>
</ol>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-05-17T12:15+0800</p>
<p class="author">Author: sunway</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.1 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 23</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
