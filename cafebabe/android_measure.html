<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Android Measure</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Android Measure"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-05-17T12:29+0800"/>
<meta name="author" content="sunway"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>    <link rel="stylesheet" type="text/css" href="stylesheet.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Android Measure</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 onMeasure</a>
<ul>
<li><a href="#sec-1-1">1.1 LinearLayout.onMeasure</a></li>
<li><a href="#sec-1-2">1.2 FrameLayout.onMeasure</a></li>
<li><a href="#sec-1-3">1.3 ListView.onMeasure</a></li>
<li><a href="#sec-1-4">1.4 android:height &amp; android:layout<sub>height</sub> &amp; intrinsic height</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> onMeasure</h2>
<div class="outline-text-2" id="text-1">

<p>  see <a href="#requestLayout">@requestLayout</a>
</p>
<p>
  view的drawing分为两个阶段:
</p><ol>
<li>measure
</li>
<li>layout
</li>
</ol>

<p>  这两步完成后才能进行drawing.
</p>
<p>
  通过调用view.measure()可以对view进行measure,调用完成后可以得该view期望的宽度和
  高度. view.measure()主要是对view-tree进行top-down的traversal,在遍历子树的过程
  中,父节点view会将对子节点view大小的要求通过 View.MeasureSpec 传递给子节点.即:
  MeasureSpec 是父节点对子节点大小的要求,例如,要求子节点大小不能超过多少dip. 父节
  点在计算子节点的 MeasureSpec 时, 会综合考虑当前已经measure过的子树的情况,以及要
  measure的子节点的 LayoutParam, 与 MeasureSpec 相反, LayoutParam 是子节点对父节
  点的要求, 例如 子节点通过 LayoutParam 告诉父节点, 它希望 FILL<sub>PARENT</sub>,父节点在制
  定 MeasureSpec 时,会考虑子节点的要求.
</p>
<p>
  MeasureSpec: 父节点的要求
</p>
<p>
  一个 MeasureSpec 包括两方面信息: measure的模式和大小
</p>
<p>
  measure模式有三种:
</p><ul>
<li>UNSPECIFIED
</li>
<li>AT<sub>MOST</sub>
</li>
<li>EXACTLY
</li>
</ul>


<p>
  其中, AT<sub>MOST表示子节点不能超过该大小</sub>,EXACTLY表示子节点应该这么大.
</p>
<p>
  LayoutParam: 子节点的要求
</p>
<p>
  LayoutParam 关于大小也有三种值:
</p><ul>
<li>FILL<sub>PARENT</sub>   表示子节点希望充满父节点.
</li>
<li>WRAP<sub>CONTENT</sub>  表示子节点只希望够用就好.
</li>
<li>固定的大小,如10dip
</li>
</ul>


<p>
  父节点会将固定大小的 LayoutParam 映射为 MeasureSpec 的 EXACTLY 模式. 通常会将
  FILL<sub>PARENT映射为</sub> EXACTLY 模式. 而将 WRAP<sub>CONTENT</sub> 映射为 AT<sub>MOST</sub> 模式.
</p>
<p>
  但考虑这个 layout:
</p>


<pre class="example">&lt;LinearLayout layout_height="wrap_content"&gt;
&lt;MyView layout_height="fill_parent"&gt;

&lt;/MyView&gt;
&lt;/LinearLayout&gt;
</pre>


<p>  
  虽然 MyView 使用的是fill<sub>parent</sub>, 但因为父节点的高度为wrap<sub>content</sub>, 所以子节点的
  模式也只能是 AT<sub>MOST</sub>, 而不能是 EXACTLY
</p>
</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> LinearLayout.onMeasure</h3>
<div class="outline-text-3" id="text-1-1">

<p>   以纵向的 LinearLayout 为例:
   假设该 layout:
</p>


<pre class="example">&lt;LinearLayout layout_height="fill_parent"&gt;
&lt;Button layout_height="wrap_content"&gt;&lt;/Button&gt;
&lt;Button layout_height="wrap_content"&gt;&lt;/Button&gt;
&lt;/LinearLayout&gt;
</pre>

<p>
   则对 Button1 measure 时, 其 spec 为: AT<sub>MOST</sub>:483 (483为最大屏幕高度), 然后设 Button1 的 onMeasure 返回的结果为100.
   接着对Button2进行 measure 时,其 spec 为: AT<sub>MOST</sub>: 383 (483-100)
   注意的是 MeasureSpec 不是强制的, 子节点还是可以在 onMeasure 返回任意值.
</p>
<p>
   <b>Note:</b>
   when determine how big next child would like to be, If this or previous children have given a weight, then we allow it to
   use all available space (and we will shrink things later if needed).
   i.e. if Button1 or Button2 has specified a `weight`, when measure Button2, it's spec will be AT<sub>MOST</sub>: 483, instead of 383!
</p>

</div>

<div id="outline-container-1-1-1" class="outline-4">
<h4 id="sec-1-1-1"><span class="section-number-4">1.1.1</span> Layout.Weight</h4>
<div class="outline-text-4" id="text-1-1-1">

<p>    只有LinearLayout的子节点才支持Layout.Weight. 不同的子节点可以有不同的weight, 表示其权重. LinearLayout 在第一次measure过程结束后, 会根据各个子节点的weight
    重新进行一次measure, 其目的是:将空闲的空间按weight重新分配给各子节点, 或将"按weight将超出的空间从各子节点里除去"
    对第一种情况:
    第一次measure后的情况:            再次measure后的情况:
</p>



<pre class="example">+-----------------+            +-----------------+
| +-------------+ |            | +-------------+ |
| | view1 h=2   | |            | | view1       | |
| | weight=1    | |            | | weight=1    | |
| +-------------+ |            | | h=4         | |
| +-------------+ |            | |             | |
| | view2 h=3   | | --------&gt;  | +-------------+ |
| | weight=0    | |            | +-------------+ |
| |             | |            | | view2       | |
| +-------------+ |            | | weight=0    | |
|   blank=2       |            | | h=3         | |
|                 |            | +-------------+ |
+-----------------+            +-----------------+
</pre>

<p>
    对第二种情况:
</p>


<pre class="example">+-----------------+            +-----------------+
| +-------------+ |            | +-------------+ |
| | view1 h=2   | |            | | view1 h=2   | |
| | weight=0    | |            | | weight=0    | |
| +--------- ---+ |            | +--------- ---+ |
| +-------------+ |            | +-------------+ |
| | view2 h=7   | | --------&gt;  | | view2 h=6   | |
| | weight=1    | |            | | weight=1    | |
| |             | |            | |             | |
| |             | |            | |             | |
| |             | |            | |             | |
| |             | |            | +-------------+ |
+-+-------------+-+            +- ------------- -+
  +-------------+
</pre>

<p>
    对比:
</p>


<pre class="example">+-----------------+            +-----------------+
| +-------------+ |            | +-------------+ |
| | view1 h=2   | |            | | w=1   h=1   | |
| | weight=1    | |            | +-------------+ |
| +--------- ---+ |            | +--------- ---+ |
| +-------------+ |            | |             | |
| | view2 h=7   | | --------&gt;  | | view2 h=7   | |
| | weight=0    | |            | | weight=0    | |
| |             | |            | |             | |
| |             | |            | |             | |
| |             | |            | |             | |
| |             | |            | +-------------+ |
+-+-------------+-+            +- ------------- -+
  +-------------+
</pre>


<p>
    即: 第一次measure后剩余的或超出的空间会按各子节点weight的比例加(或减)到各子节点.
    注: 第二次measure时一定是 `EXACTLY MODE`, 这也决定了 ListView 在 LinearLayout 里因为 WEIGHT  第二次被 measure 时, 不会调用 measureHeightOfChildren
    (see <a href="#sec-1-3">ListView.onMeasure</a>)
    由于weight的存在, LinearLayout 需要 对所有子节点 measure 两次.
    另外, 若 child 的 LP 为0 dip, 则 child.onMeasure 根本不会被调用,直接设为exactly 0, 例如:
    两个widget, 第一个为0dip, weight为1, 第二个为fill<sub>parent</sub>,weight为0,则:
</p><ul>
<li>第一次measure时:totalHeight=483 (0+483), delta=483-483=0
</li>
<li>第二次measure时:第一个widget onMeasure 时的高度为exactly 0 (orig(0)+delta(0) * weight(1)/totalWeight(1) =0,
      第二个的为 exactly 483 (orig(483)+delta(0) * 0/1)
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> FrameLayout.onMeasure</h3>
<div class="outline-text-3" id="text-1-2">

</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> ListView.onMeasure</h3>
<div class="outline-text-3" id="text-1-3">




<pre lang="java" line="1">
       ListView.onMeasure()
         heightSize=MeasureSpec.getSize();
         if (heightMode==AT_MOST) // ListView LayoutParam is `wrap_content`, or it's outer Layout is `wrap_content`
           heightSize= measureHeightOfChildren(maxHeight);
             for (i=startPos;i<endPos;++i):
               obtainView() ;; will invoke adapter.getView()
               measureChild();
               returnHeight+=childHeight;
               if (returnHeight>maxHeight):
                 return returnHeight;
             return returnHeight;
         setMeasuredDimension(..,heightSize);
</pre>

<p>
       That is:
</p><ol>
<li>when ListView's LayoutParam is not `wrap<sub>content`</sub>, it will use height as large as possible
</li>
<li>when ListView's LayoutParam or it's parent layout's LayoutParam is `wrap<sub>content`</sub>, it will iterate all it's child through getView()
            to determine a suitable size;
</li>
</ol>

<p>       thus, `wrap<sub>content`</sub> LayoutParam for ListView should be considered for performance penalty.
</p>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> android:height &amp; android:layout<sub>height</sub> &amp; intrinsic height</h3>
<div class="outline-text-3" id="text-1-4">

<ul>
<li>every view has the android:layout<sub>height</sub> property
</li>
<li>only some view has android:height property (currently, only TextView and it derivative has this property)

<p>
     android:height property is for views that is `variable height`,
     e.g. TextView by setting the android:height of TextView to 3 lines, the
     AT<sub>MOST</sub> MeasureSpec knows how height the TextView want to be.
</p>
</li>
<li>only some view which hold drawables (ImageView, ImageButton, &hellip;) has the conception of intrinsic height
<ul>
<li>for ImageView:
       ImageView has the conception of intrinsic height, but it doesn't has the android:height property (only has max<sub>height</sub>, min<sub>height</sub>)
       intrinsic height is the drawable's orig height.
       ImageView use intrinsic<sub>height</sub>/width to calculate a desiredAspect (0..1), ImageView.onMeasure will try to re-size the measure dimensions
       according to the desiredAspect, if allowed (MeasureSpec is not `EXACTLY`)

<p>
       although intrinsic<sub>height</sub>/width may be used differently, as a common rule, MeasureSpec.EXACTLY will always override the intrinsic<sub>height</sub>/width
       setting.
</p></li>
<li>for TextView:
       TextView has the android:height property, it can be measured in px,dp,.. and lines, it is a hint for `AT<sub>MOST`</sub> how height it want to be.
       in details, setHeight(h) just set both MaxHeight and MinHeight to h, during the measure phase, if MeasureSpec is not EXACTLY, the
       TextView.getDesiredHeight() will calculate desired height as follows:



<pre class="example">desired = Math.min(desired, mMaximum);
desired = Math.max(desired, mMinimum);
</pre>

</li>
</ul>

</li>
</ul>


<p>       
  To summarize:
</p><ul>
<li>android:height is only for AT<sub>MOST</sub>, that is EXACTLY will always override android:height.
</li>
<li>currently, only TextView and it derivative has android:height property.
</li>
</ul>

</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-05-17T12:29+0800</p>
<p class="author">Author: sunway</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.1 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 23</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
