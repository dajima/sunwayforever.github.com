<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Android Sqlite</title>
<!-- 2014-07-01 Tue 10:54 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Wei Sun (孙伟)" />
<link rel="stylesheet" type="text/css" href="/stylesheets/main.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Android Sqlite</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Android Sqlite</a>
<ul>
<li><a href="#sec-1-1">1.1. SQLiteDatabase &amp; SQLiteDatabase (c)</a></li>
<li><a href="#sec-1-2">1.2. SQLiteStatement (c)</a></li>
<li><a href="#sec-1-3">1.3. SQLiteSession</a></li>
<li><a href="#sec-1-4">1.4. SQLiteConnection &amp; SQLiteConnectionPool</a></li>
<li><a href="#sec-1-5">1.5. SQLiteProgram &amp; SQLiteQuery &amp; SQLiteQueryBuilder</a></li>
<li><a href="#sec-1-6">1.6. SQLiteDebug</a></li>
<li><a href="#sec-1-7">1.7. Cursor &amp; CursorWindow</a></li>
<li><a href="#sec-1-8">1.8. Other</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Android Sqlite</h2>
<div class="outline-text-2" id="text-1">
<pre class="example">
                                 +----------------+
                                 | SQLiteDatabase |                         +------------------+
                                 +-+----------+---+                  +-----&gt;+ SQLiteConnection-+-&lt;---+
                                   |          |                      |      +------------------+     |
                                   |          v                      |      +------------------+     |
     +--------------------+--------+     +----+------------------+   +-----&gt;+ SQLiteConnection |     |
     |                    |              | SQLiteConnection Pool-+---+      +-----+-----+------+     |
     v thread_1           v thread_2     +-------+---------------+                |     ^            |
+----+----------+    +----+----------+           ^                                |     |            |
| SQLiteSession |    | SQLiteSession-+-----------+      +----------------------+  |     |            |
+----+-------+--+    +------+--+-----+           |      |PreparedStatementCache+&lt;-+     |            |
     |       |              |                    |      +----------------------+        |            |
     |       +--------------+--------------------+                                      |            |
     |                      |                                                           |            |
     |                      +-----------------------------------------------------------+            |
     |                                                                                               |
     +-----------------------------------------------------------------------------------------------+
</pre>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> SQLiteDatabase &amp; SQLiteDatabase (c)</h3>
<div class="outline-text-3" id="text-1-1">
</div><div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1"><span class="section-number-4">1.1.1</span> addCustomFunction</h4>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> SQLiteStatement (c)</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Note that `SQLiteStatement' has nothing to do with the native
`prepared statement', it nothing but a `helper class' to store:
</p>
<ul class="org-ul">
<li>sql string
</li>
<li>bind args
</li>
<li>db connection (session)
</li>
</ul>

<p>
In fact, there is ONE class named `PreparedStatement', defined in the
`SQLiteConnection', which corresponds to the `native prepared
statement', and also there is `PreparedStatementCache' in
SQLiteConnection to avoid redundant statement preparations. So, cache
`SQLiteStatement' manually may make no sense? so I really doubt that
`android providers should use DatabaseUtils.InsertHelper to cache
SQLiteStatement', as mentioned in:
</p>

<p>
<a href="http://www.outofwhatbox.com/blog/2010/12/android-using-databaseutils-inserthelper-for-faster-insertions-into-sqlite-database/#comment-2685">android-using-databaseutils-inserthelper-for-faster-insertions-into-sqlite-database/</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> SQLiteSession</h3>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> SQLiteConnection &amp; SQLiteConnectionPool</h3>
<div class="outline-text-3" id="text-1-4">
</div><div id="outline-container-sec-1-4-1" class="outline-4">
<h4 id="sec-1-4-1"><span class="section-number-4">1.4.1</span> Yield</h4>
</div>
<div id="outline-container-sec-1-4-2" class="outline-4">
<h4 id="sec-1-4-2"><span class="section-number-4">1.4.2</span> WAL (Write-ahead Logging)</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
<a href="http://sqlite.org/wal.html">http://sqlite.org/wal.html</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> SQLiteProgram &amp; SQLiteQuery &amp; SQLiteQueryBuilder</h3>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> SQLiteDebug</h3>
</div>
<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> Cursor &amp; CursorWindow</h3>
<div class="outline-text-3" id="text-1-7">
</div><div id="outline-container-sec-1-7-1" class="outline-4">
<h4 id="sec-1-7-1"><span class="section-number-4">1.7.1</span> SQLiteCursorDriver</h4>
</div>
<div id="outline-container-sec-1-7-2" class="outline-4">
<h4 id="sec-1-7-2"><span class="section-number-4">1.7.2</span> CursorFactory</h4>
</div>
<div id="outline-container-sec-1-7-3" class="outline-4">
<h4 id="sec-1-7-3"><span class="section-number-4">1.7.3</span> Cursor</h4>
<div class="outline-text-4" id="text-1-7-3">
</div><div id="outline-container-sec-1-7-3-1" class="outline-5">
<h5 id="sec-1-7-3-1"><span class="section-number-5">1.7.3.1</span> Cursor Class Hierarchy</h5>
<div class="outline-text-5" id="text-1-7-3-1">
<pre class="example">
                          -+----------+
                           | Cursor/I |
                          -+----+-----+
                                |
                                |
                     -+---------+-----------+
                      | CrossProcessCursor/I|
                     -+----+----+-----------+
                                |
                                |
                      -+-----+--+---------+
                       | AbstractCursor/A |
                      -+--------+---------+
                                |
            -+------------------+---------------+----------------------+
             |                                  |                      |
-+-----------+--------------+          -+-------+------+       -+------+------+
 | AbstractWindowedCursor/A |           | MatrixCursor |        | MergeCursor |
-+-----------+--------------+          -+--------------+       -+-------------+
             |
            -+----------------------------+
             |                            |
    -+-------+------+      -+-------------+-------------+
     | SqliteCursor |       | BulkCursorToCursorAdaptor |
    -+--------------+      -+---------------------------+
</pre>
</div>
<ol class="org-ol"><li>Cursor across process<br  /><div class="outline-text-6" id="text-1-7-3-1-1">
<p>
When Cursor in the remote process need to be returned to local process, the
remote Cursor will be wrapped into a binder object named
`CursorToBulkCursorAdaptor`, which is not a cursor, but implements methods like
`onMove`, `getWindow`, etc.
</p>

<p>
When the local process received the `CursorToBulkCursorAdaptor` binder, it
again will be wrapped into a local cursor object named
`BulkCursorToCursorAdaptor`, which is a `AbstractWindowedCursor`
</p>


<pre class="example">
            -+------------------------+
             | AbstractWindowedCursor |
            -+----------+-------------+
                        |
                        |
          -+------------+--------------+
           | BulkCursorToCursorAdaptor |
          -+------------+--------------+
                        |
                        |
               -+-------+------+        local process (e.g. app)
--------------- |  BulkCursor  | -------------------
               -+-------+------+        remote process (e.g. provider)
                        |
                        |
          -+------------+--------------+
           | CursorToBulkCursorAdaptor |
          -+------------+--------------+
                        |
                        |
                 -+----------+
                  |  Cursor  |
                 -+----------+
</pre>
</div>
</li></ol>
</div>
<div id="outline-container-sec-1-7-3-2" class="outline-5">
<h5 id="sec-1-7-3-2"><span class="section-number-5">1.7.3.2</span> Code Snippet</h5>
<div class="outline-text-5" id="text-1-7-3-2">
</div><ol class="org-ol"><li>moveToFirst<br  /><div class="outline-text-6" id="text-1-7-3-2-1">
<div class="org-src-container">

<pre class="src src-text">AbstractCursor.moveToFirst
  AbstractCursor.moveToPosition(0)
    ret=SqliteCursor.onMove(origPos,0)
      if mWindow==null || newPosition &lt; mWindow.getStartPosition()
         || newPosition &gt;= mWindow.getStartPosition()+ mWindow.getNumRows():
         SqliteCursor.fillWindow(newPosition)
           mWindow.setStartPosition(newPosition)
           getQuery().fillWindow(newPosition)
             SQLiteQuery.nativeFillWindow(nHandle, nStatement, window.mWindowPtr,
                        startPos, mOffsetIndex);
               // Bind the offset parameter, telling the program which row to start with
               sqlite3_bind_int(statement, offsetParam, startPos);
               while (!windowFull):
                 sqlite3_step(statement);
                 window-&gt;allocRow();
                 for (int i = 0; i &lt; numColumns; i++):
                   int type = sqlite3_column_type(statement, i);
                   if (type == SQLITE_TEXT):
                     const char* text = reinterpret_cast&lt;const char*&gt;(sqlite3_column_text(statement, i));
                     window-&gt;putString(addedRows, i, text, sizeIncludingNull);
                   elif: // other type
                 // end for
               // end while
               sqlite3_reset(statement);
    if ret:
      mPos=newPos;
</pre>
</div>
</div>
</li>

<li>getString<br  /><div class="outline-text-6" id="text-1-7-3-2-2">
<div class="org-src-container">

<pre class="src src-text">Cursor.getString(pos)
  AbstractWindowedCursor.getString(pos)
    mWindow.getString(pos)
      nativeGetString(pos)
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-7-3-3" class="outline-5">
<h5 id="sec-1-7-3-3"><span class="section-number-5">1.7.3.3</span> SQLiteCursor</h5>
<div class="outline-text-5" id="text-1-7-3-3">
<ul class="org-ul">
<li>SQLiteCursorDriver
used to create the SqliteCursor
</li>
<li>SQLiteQuery
used to invoke `nativefillWindow`
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-7-3-4" class="outline-5">
<h5 id="sec-1-7-3-4"><span class="section-number-5">1.7.3.4</span> To summarize</h5>
<div class="outline-text-5" id="text-1-7-3-4">
<ol class="org-ol">
<li>Cursor by itself is not `CrossProcess`, but with the help of `BulkCursor`
,`BulkCursorToCursorAdaptor` and `CursorToBulkCursorAdaptor`, Cursor can be
`CrossProcess`
</li>
<li>The most important methods of the `Cursor` object:
<ol class="org-ol">
<li>fillWindow

<p>
`nativefillWindow` will execute the real query, and fill the result set to
the `CursorWindow`.  ps. `getCount` will invoke `fillWindow` implicitly.
</p>
</li>

<li>onMove

<p>
`fillWindow` is during `onMove`, e.g. `moveToFirst`, `moveToNext`, &#x2026;
</p>
</li>
</ol>
</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-sec-1-7-4" class="outline-4">
<h4 id="sec-1-7-4"><span class="section-number-4">1.7.4</span> CursorWindow</h4>
<div class="outline-text-4" id="text-1-7-4">
<p>
`CursorWindow` is parcelable, it represents a `window` of sqlite query
data. The underlying data of a Java CursorWindow object is managed by
CursorWindow c++ object, in both of the server side and the client
side.
</p>
</div>

<div id="outline-container-sec-1-7-4-1" class="outline-5">
<h5 id="sec-1-7-4-1"><span class="section-number-5">1.7.4.1</span> init</h5>
<div class="outline-text-5" id="text-1-7-4-1">
<div class="org-src-container">

<pre class="src src-text">onMove
  fillWindow
    clearOrCreateWindow
      mWindow = new CursorWindow(name);
        // sCursorWindowSize specifies the window size in kb, e.g. 2048 Kb
        mWindowPtr = CursorWindow.nativeCreate(name, sCursorWindowSize);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-7-4-2" class="outline-5">
<h5 id="sec-1-7-4-2"><span class="section-number-5">1.7.4.2</span> how CursorWindow is passed across process</h5>
<div class="outline-text-5" id="text-1-7-4-2">
<p>
Because `CursorWindow` is only a parcelable (not a binder), so the remote
`CursorWindow` need to be fetched by the local process again and again,
e.g. during local `onMove`
</p>

<div class="org-src-container">

<pre class="src src-text">BulkCursorToCursorAdaptor.onMove
  if (mWindow == null
      || newPosition &lt; mWindow.getStartPosition()
      || newPosition &gt;= mWindow.getStartPosition() + mWindow.getNumRows()):
    setWindow(mBulkCursor.getWindow(newPosition));
      // remote process
      CursorToBulkCursorAdaptor.getWindow(newPosition)
        mCursor.moveToPosition(startPos)
        return mCursor.getWindow()
          // SQLiteCursor
          mCursor.fillWindow(position, window);
            mQuery.fillWindow(position,window);
              getSession().executeForCursorWindow();
                SQLiteConnection.nativeExecuteForCursorWindow(start, requiredRow)
                // native
                  while (window not full):
                    sqlite3_step(stmt);
                    copy_row(window)
                  sqlite3_reset(stmt)
                nativeFinalizeStatement(stmt);
</pre>
</div>
</div>

<ol class="org-ol"><li>关于 CursorWindow 的一个 bug (or feature)<br  /><div class="outline-text-6" id="text-1-7-4-2-1">
<p>
每次 onMove (包括 cursor.moveToPosition 等) 都会导致底层的 statement 实
际上会重新查询 &#x2026;. 所以这种设计会导致这个 bug (or feature?)
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #859900;">private</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">query</span>() {
    <span style="color: #b58900;">SQLiteDatabase</span> <span style="color: #268bd2;">db</span> = SQLiteDatabase.openDatabase(<span style="color: #2aa198;">"/storage/sdcard1/test.db"</span>, <span style="color: #2aa198;">null</span>,<span style="color: #2aa198;">SQLiteDatabase</span>.OPEN_READWRITE, <span style="color: #2aa198;">null</span>);
    <span style="color: #b58900;">Cursor</span> <span style="color: #268bd2;">cursor</span>=db.query(<span style="color: #2aa198;">"test"</span>, <span style="color: #859900;">new</span> <span style="color: #b58900;">String</span>[] {<span style="color: #2aa198;">"name"</span>,<span style="color: #2aa198;">"count"</span>}, <span style="color: #2aa198;">null</span>,<span style="color: #2aa198;">null</span>, <span style="color: #2aa198;">null</span>, <span style="color: #2aa198;">null</span>, <span style="color: #2aa198;">"name"</span>);
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"query:get count:"</span>+cursor.getCount());
    cursor.moveToFirst();
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"moveToFirst: data:"</span>+cursor.getString(0));
    cursor.moveToLast();
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"moved to last"</span>);
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"insert a row"</span>);

    db.beginTransaction();
    db.execSQL(<span style="color: #2aa198;">"INSERT INTO test VALUES (\"aaa\",1)"</span>);
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"done"</span>);
    db.setTransactionSuccessful();
    db.endTransaction();

    cursor.moveToFirst();
    Log.e(<span style="color: #2aa198;">"sunway"</span>,<span style="color: #2aa198;">"moveToFirst again: data:"</span>+cursor.getString(0));
    cursor.close();
}
</pre>
</div>

<p>
当原有数据足够多时 (保证 moveToLast 会调用 fillWindow 替换掉当前
window), 对同一 cursor 调用两次 moveToFirst 查询的结果不同 &#x2026;. 若要避
免这个情况, 要么底层的 cursor window 足够大, 能容纳所有的内容, 要么
cursor 查询返回后不 finalized statement, 这样可以保证 read transaction
持有 shared lock, 那么其他 write transaction 会因为无法获得 exclusive
lock 而无法修改数据库.
</p>
</div>
</li></ol>
</div>
<div id="outline-container-sec-1-7-4-3" class="outline-5">
<h5 id="sec-1-7-4-3"><span class="section-number-5">1.7.4.3</span> CursorWindow and `ashmem'</h5>
<div class="outline-text-5" id="text-1-7-4-3">
<p>
The underlying data of a Java CursorWindow is managed by CursorWindow
c++ object, and is stored using `ashmem'
</p>

<div class="org-src-container">

<pre class="src src-c++">  <span style="color: #b58900;">status_t</span> <span style="color: #2aa198;">CursorWindow</span>::<span style="color: #268bd2;">writeToParcel</span>(<span style="color: #b58900;">Parcel</span>* <span style="color: #268bd2;">parcel</span>) {
      <span style="color: #b58900;">status_t</span> <span style="color: #268bd2;">status</span> = parcel-&gt;writeString8(mName);
      <span style="color: #859900;">if</span> (<span style="color: #dc322f;">!</span>status) {
          status = parcel-&gt;writeDupFileDescriptor(mAshmemFd);
      }
      <span style="color: #859900;">return</span> status;
  }

<span style="color: #b58900;">status_t</span> <span style="color: #2aa198;">CursorWindow</span>::<span style="color: #268bd2;">createFromParcel</span>(<span style="color: #b58900;">Parcel</span>* <span style="color: #268bd2;">parcel</span>, <span style="color: #b58900;">CursorWindow</span>** <span style="color: #268bd2;">outCursorWindow</span>) {
    <span style="color: #b58900;">String8</span> <span style="color: #268bd2;">name</span> = parcel-&gt;readString8();

    <span style="color: #b58900;">status_t</span> <span style="color: #268bd2;">result</span>;
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">ashmemFd</span> = parcel-&gt;readFileDescriptor();
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">...</span>
}
</pre>
</div>

<p>
So, CursorWindow parceling is quite efficient using `ashmem', and
that why CursorWindow could deliver more than 1MB data using binder.
</p>

<pre class="example">
~@sunway-x230&gt; adb shell procmem 642|grep "CursorWindow"
     0K       0K       0K       0K       0K       0K       0K       0K  /dev/ashmem/CursorWindow:
     0K       0K       0K       0K       0K       0K       0K       0K  /dev/ashmem/CursorWindow:
     4K       4K       2K       0K       0K       4K       0K       0K  /dev/ashmem/CursorWindow:
     0K       0K       0K       0K       0K       0K       0K       0K  /dev/ashmem/CursorWindow:
     4K       4K       4K       4K       0K       0K       4K       0K  /dev/ashmem/CursorWindow:
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> Other</h3>
<div class="outline-text-3" id="text-1-8">
</div><div id="outline-container-sec-1-8-1" class="outline-4">
<h4 id="sec-1-8-1"><span class="section-number-4">1.8.1</span> adb shell dumpsys meminfo pid</h4>
<div class="outline-text-4" id="text-1-8-1">
<div class="org-src-container">

<pre class="src src-text">SQL
        MEMORY_USED:      992
 PAGECACHE_OVERFLOW:      255          MALLOC_SIZE:       62

DATABASES
     pgsz     dbsz   Lookaside(b)          cache  Dbname
        4      300            460       56/65/25  /data/user/0/com.android.providers.contacts/databases/contacts2.db
        1        9                         0/0/0    (attached) presence_db
        4      300            498       39/54/24  /data/user/0/com.android.providers.contacts/databases/profile.db
        1        9                         0/0/0    (attached) presence_db
        1       19             44        39/30/5  :memory:
</pre>
</div>

<ol class="org-ol">
<li>pgsz 是 page<sub>size</sub>, 单位 KB.
</li>
<li>dbsz 是 db 文件大小, KB
</li>
<li>lookaside 是已经 checkout 的 lookaside slot 的个数 (<a href="http://www.sqlite.org/c3ref/c_dbstatus_lookaside_used.html">http://www.sqlite.org/c3ref/c_dbstatus_lookaside_used.html</a>)
</li>
<li>cache 是 android 使用的 statement cache 的 hit/miss/num<sub>pages</sub> (和
pcache 无关&#x2026;)
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Wei Sun (孙伟)</p>
<p class="email">Email: <a href="mailto:wei.sun@spreadtrum.com">wei.sun@spreadtrum.com</a></p>
<p class="date">Created: 2014-07-01 Tue 10:54</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.5g)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
