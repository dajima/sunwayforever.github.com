<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Jave Interface</title>
<!-- 2014-01-30 Thu 13:54 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="wei.sun" />
<link rel="stylesheet" type="text/css" href="/stylesheets/main.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Jave Interface</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Java interface vs. C++ multiple inheritance, the method invocation overhead</a>
<ul>
<li><a href="#sec-1-1">1.1. C++ multiple inheritance&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ATTACH">ATTACH</span></span></a></li>
<li><a href="#sec-1-2">1.2. Java interface&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ATTACH">ATTACH</span></span></a></li>
<li><a href="#sec-1-3">1.3. To summaries:</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Java interface vs. C++ multiple inheritance, the method invocation overhead</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><a id="ID-83a89ae3-bc29-4858-81ba-65e01ff28ad1" name="ID-83a89ae3-bc29-4858-81ba-65e01ff28ad1"></a><span class="section-number-3">1.1</span> C++ multiple inheritance&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ATTACH">ATTACH</span></span></h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #859900;">class</span> <span style="color: #b58900;">B1</span> {
    <span style="color: #859900;">virtual</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">foo</span>() {}
};
<span style="color: #859900;">class</span> <span style="color: #b58900;">B2</span> {
    <span style="color: #859900;">virtual</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">bar</span>() {}
};

<span style="color: #859900;">class</span> <span style="color: #b58900;">D</span>:<span style="color: #859900;">public</span> <span style="color: #b58900;">B1</span>,<span style="color: #859900;">public</span> <span style="color: #b58900;">B2</span> {
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">foo</span>() {}
    <span style="color: #b58900;">void</span> <span style="color: #268bd2;">bar</span>() {}
    <span style="color: #859900;">virtual</span> <span style="color: #b58900;">void</span> <span style="color: #268bd2;">test</span>() {}
};

<span style="color: #cb4b16;">#include</span> 
<span style="color: #cb4b16;">#include</span> 
<span style="color: #859900;">using</span> <span style="color: #859900;">namespace</span> <span style="color: #2aa198;">std</span>;

<span style="color: #b58900;">int</span> <span style="color: #268bd2;">main</span>(<span style="color: #b58900;">int</span> <span style="color: #268bd2;">argc</span>, <span style="color: #b58900;">char</span> *<span style="color: #268bd2;">argv</span>[]) {
    <span style="color: #b58900;">D</span> * <span style="color: #268bd2;">pd</span>=<span style="color: #859900;">new</span> <span style="color: #b58900;">D</span>();
    <span style="color: #b58900;">B1</span> * <span style="color: #268bd2;">pb1</span>=pd;
    <span style="color: #b58900;">B2</span> * <span style="color: #268bd2;">pb2</span>=pd;

    printf(<span style="color: #2aa198;">"entries of D's vtbl: (actually, is B1's vtbl)\n"</span>);
    <span style="color: #b58900;">int</span> * <span style="color: #268bd2;">ptr</span>=<span style="color: #859900;">reinterpret_cast</span>(pd);
    <span style="color: #b58900;">int</span> * <span style="color: #268bd2;">vtbl</span>=(<span style="color: #b58900;">int</span> *)(*(ptr));
    printf(<span style="color: #2aa198;">"%x\n"</span>,*(vtbl+0));
    printf(<span style="color: #2aa198;">"%x\n"</span>,*(vtbl+1));
    printf(<span style="color: #2aa198;">"%x\n"</span>,*(vtbl+2));

    printf(<span style="color: #2aa198;">"entries of B1's vtbl\n"</span>);
    ptr=<span style="color: #859900;">reinterpret_cast</span>(pb1);
    vtbl=(<span style="color: #b58900;">int</span> *)(*(ptr));
    printf(<span style="color: #2aa198;">"%x\n"</span>,*(vtbl+0));
    printf(<span style="color: #2aa198;">"%x\n"</span>,*(vtbl+1));
    printf(<span style="color: #2aa198;">"%x\n"</span>,*(vtbl+2));

    printf(<span style="color: #2aa198;">"entries of B2's vtbl\n"</span>);
    ptr=<span style="color: #859900;">reinterpret_cast</span>(pb2);
    vtbl=(<span style="color: #b58900;">int</span> *)(*(ptr));
    printf(<span style="color: #2aa198;">"%x\n"</span>,*(vtbl+0));
    <span style="color: #859900;">return</span> 0;
}
</pre>
</div>

<p>
Memory layout
</p>

<p>
That is, for C++ multiple inheritance, vptl is seperated to different base
class. For each base class, there is ONE vptr (and thus vptl). There is not so
much overhead comparing to single inheritance, it is quite easy to find the
correct vptl of a certain base class.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><a id="ID-63bf50ee-ead6-482a-85a5-296c2f86a970" name="ID-63bf50ee-ead6-482a-85a5-296c2f86a970"></a><span class="section-number-3">1.2</span> Java interface&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ATTACH">ATTACH</span></span></h3>
<div class="outline-text-3" id="text-1-2">
<p>
Java interface is similar with C++ multiple inheritance. Java use the
`invokeinterface` opcode to call interface functions.
</p>
<div class="org-src-container">

<pre class="src src-java">CASE(<span style="color: #2aa198;">_invokeinterface</span>): {
    <span style="color: #b58900;">u2</span> <span style="color: #268bd2;">index</span> = Bytes::get_native_u2(pc+1);
    ConstantPoolCacheEntry* cache = cp-&gt;entry_at(index);
    <span style="color: #b58900;">methodOop</span> <span style="color: #268bd2;">callee</span>;
    <span style="color: #b58900;">klassOop</span> <span style="color: #268bd2;">iclass</span> = (<span style="color: #b58900;">klassOop</span>)cache-&gt;f1();
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">get receiver</span>
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">parms</span> = cache-&gt;parameter_size();
    <span style="color: #b58900;">oop</span> <span style="color: #268bd2;">rcvr</span> = STACK_OBJECT(-parms);
    instanceKlass* int2 = (instanceKlass*) rcvr-&gt;klass()-&gt;klass_part();
    itableOffsetEntry* ki = (itableOffsetEntry*) int2-&gt;start_of_itable();
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">i</span>;
    <span style="color: #859900;">for</span> ( i = 0 ; i &lt; int2-&gt;itable_length() ; i++, ki++ ) {
        <span style="color: #859900;">if</span> (ki-&gt;interface_klass() == iclass) <span style="color: #859900;">break</span>;
    }
    <span style="color: #b58900;">int</span> <span style="color: #268bd2;">mindex</span> = cache-&gt;f2();
    itableMethodEntry* im = ki-&gt;first_method_entry(rcvr-&gt;klass());
    callee = im[mindex].method();
}
</pre>
</div>

<p>
Memory layout:
</p>

<p>
The `itable` is a collection the interfaces that the class implements. Each
entry of the itable contains the vtable of the interface.
</p>

<p>
That is, `invokeinterface` will first iterate over the itable to find the right
interface, then get the corresponding vtable, then invoke the correct method.
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> To summaries:</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Both C++ and Java has provided several `vtable`s to support multiple inheritance
or interface. But C++ tends to seperate the vtables, while Java tends to keep
them together.
</p>

<p>
For C++, the class cast procedure also do the work of `locate the correct
vtable`, what’s more, the compiler knows how to do the cast at compile
time. (except for virtual inheritance), thus C++’s approach is more efficient.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: wei.sun</p>
<p class="email">Email: <a href="mailto:wei.sun@spreadtrum.com">wei.sun@spreadtrum.com</a></p>
<p class="date">Created: 2014-01-30 Thu 13:54</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.5g)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
