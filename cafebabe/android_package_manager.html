<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Android PackageManager</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Android PackageManager"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-05-17T12:29+0800"/>
<meta name="author" content="sunway"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>    <link rel="stylesheet" type="text/css" href="stylesheet.css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Android PackageManager</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 PackageManager</a>
<ul>
<li><a href="#sec-1-1">1.1 installd</a></li>
<li><a href="#sec-1-2">1.2 forward<sub>lock</sub></a></li>
<li><a href="#sec-1-3">1.3 install Package</a></li>
<li><a href="#sec-1-4">1.4 Replace Package</a></li>
<li><a href="#sec-1-5">1.5 Uninstall package</a></li>
<li><a href="#sec-1-6">1.6 resolveActivity</a></li>
<li><a href="#sec-1-7">1.7 android package vs. java package vs. android application</a></li>
<li><a href="#sec-1-8">1.8 UID &amp; GID</a></li>
<li><a href="#sec-1-9">1.9 Multi-User support</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> PackageManager</h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> installd</h3>
<div class="outline-text-3" id="text-1-1">

<p>installd is a system binary running as `root` and listening on `installd` socket.
see <a href="#dalvik-cache">@dalvik-cache</a>
</p><ul>
<li>when installing and uninstalling package, PMS need to mkdir/rmdir /data/data/xxx, but those data dirs is not accessable by PMS (PMS running with
  `system` uid, while data dirs is owned by package uids like `app<sub>1`</sub>), so PMS need to use `installd` to access those data dir.
</li>
<li>after package is installed / deleted, PMS need invoke dex<sub>opt</sub> / rm<sub>dex</sub> to do the dirty work like optimize dex to dalvik-cache or remove dalvik-cache,
  those works are also delegated to installd.
</li>
</ul>

</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> forward<sub>lock</sub></h3>
<div class="outline-text-3" id="text-1-2">

<p>    adb install -l xxx.apk ( -l means `forward<sub>lock`</sub> install )
</p>
<p>
    when xxx.apk is `forward<sub>lock`</sub> installed
</p><ul>
<li>it's orig .apk is deleted
</li>
<li>it's res/, manifest.xml is put to /data/app/xxx.zip
      (note that .dex is cached in dalvik-cache)
</li>
</ul>

</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> install Package</h3>
<div class="outline-text-3" id="text-1-3">

<ul>
<li>there are 2 ways to install package:
<ol>
<li>push xxx.apk to any folder of /data/app, /system/app, /system/framework
</li>
<li>use PackageInstaller or adb install (which will invoke PM.installPackage())

</li>
</ol>

</li>
<li>`system` application &amp; 3rd application
  `system` is a property of ApplicationInfo after installation.
  `system` application are applications not listed in `downloaded` category in Settings, while 3rd applications are applications listed in `downloaded`
  category.

<p>      
  PackageManager will decide whether a newly installed application is a `system` application:
</p><ul>
<li>if apk is pushed to /system/app &amp; /system/framework, then it is `system` application
</li>
<li>if apk is replacing an existing old system application, then it is.
</li>
<li>&hellip;
</li>
</ul>

</li>
</ul>


</div>

<div id="outline-container-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><span class="section-number-4">1.3.1</span> adb push</h4>
<div class="outline-text-4" id="text-1-3-1">




<pre class="src src-java">FileObserver.onEvent()
  isApk=isPackageFilename():
    name.endsWith(<span style="color: #2aa198;">".apk"</span>);
  <span style="color: #859900;">if</span> <span style="color: #dc322f;">!</span>isApk:<span style="color: #859900;">return</span>;
  <span style="color: #859900;">if</span> ignoreCodePath(fullPathStr):   ;; <span style="color: #859900;">if</span> apk name is like <span style="color: #2aa198;">"xxx-1.apk"</span>, it will <span style="color: #b58900;">be</span> <span style="color: #268bd2;">ignored</span><span style="color: #dc322f;">!</span>
                                    ;; <span style="color: #859900;">this</span> is because PM.installPackage will also put installed <span style="color: #859900;">package</span> <span style="color: #2aa198;">to</span> /data/app, PM.installPackage <span style="color: #b58900;">use</span> <span style="color: #268bd2;">the</span>
                                    ;; special naming rule to prevent FileObserver from installing <span style="color: #b58900;">the</span> <span style="color: #268bd2;">apk</span> again.
    <span style="color: #859900;">return</span>
  <span style="color: #859900;">if</span> ADD_EVENTS:
    scanPackageLI(mIsRom?PARSE_IS_SYSTEM:0) ;; <span style="color: #859900;">if</span> apk is in /system/app or /system/framework, mIsRom <span style="color: #b58900;">is</span> <span style="color: #268bd2;">true</span>
                                            ;; <span style="color: #859900;">package</span> <span style="color: #2aa198;">with</span> PARSE_IS_SYSTEM flag will <span style="color: #b58900;">be</span> <span style="color: #b58900;">marked</span> <span style="color: #268bd2;">as</span> `system` application
    updatePermissionsLP()
  <span style="color: #859900;">if</span> REMOVE_EVENTS:
    removePackageLI()
  <span style="color: #859900;">if</span> addedPackage!=null:
    sendPackageBroadcast(ACTION_PACKAGE_ADDED)
  <span style="color: #859900;">if</span> removedPackage!=null:
    sendPackageBroadcast(ACTION_PACKAGE_REMOVED)
</pre>

</div>

</div>

<div id="outline-container-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><span class="section-number-4">1.3.2</span> PM.installPackage</h4>
<div class="outline-text-4" id="text-1-3-2">


</div>

<div id="outline-container-1-3-2-1" class="outline-5">
<h5 id="sec-1-3-2-1"><span class="section-number-5">1.3.2.1</span> PackageInstaller</h5>
<div class="outline-text-5" id="text-1-3-2-1">

</div>

</div>

<div id="outline-container-1-3-2-2" class="outline-5">
<h5 id="sec-1-3-2-2"><span class="section-number-5">1.3.2.2</span> install location (src &amp; dest)</h5>
<div class="outline-text-5" id="text-1-3-2-2">

<ul>
<li id="sec-1-3-2-2-1">src apk location<br/>
<ul>
<li>from DownloadManager through ContentProvider
</li>
<li>from file though MediaContainerService
</li>
</ul>

</li>
</ul>
<ul>
<li id="sec-1-3-2-2-2">app install location<br/>
the apk's install location can be internal flash / sdcard.
<ol>
<li>The apk's manifest may declares it's `install location`, including:
<ul>
<li>auto
</li>
<li>internalOnly
</li>
<li>preferExternal
</li>
</ul>

</li>
<li>PackageHelper.recommendAppInstallLocation() make the ultimate decision:
<ul>
<li>if `install location` is not set in manifest, internal will always be selected
</li>
<li>auto
    if apk's code size&gt;1MB, location will be set to external, unless external storage is slow (&lt;10% free space..
</li>
<li>internalOnly
    internal will be selected
</li>
<li>preferExternal
    always selected external unless storage is unavailable or inefficient.
</li>
<li>system setting for default installation location is also considered
</li>
</ul>

</li>
</ol>

<p>To summurize:
</p><ul>
<li>manifest's `install location`
</li>
<li>system setting for `default install location`
</li>
<li>internal/external storage status
</li>
</ul>


</li>
</ul>
</div>

</div>

<div id="outline-container-1-3-2-3" class="outline-5">
<h5 id="sec-1-3-2-3"><span class="section-number-5">1.3.2.3</span> MediaContainerService / DefaultContainerService</h5>
<div class="outline-text-5" id="text-1-3-2-3">

<p> <span class="timestamp-wrapper"><span class="timestamp-kwd">SCHEDULED: </span> <span class="timestamp">2011-03-02 Wed</span></span>  <span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED: </span> <span class="timestamp">2011-03-02 Wed 16:42</span></span><br/>
</p><ul>
<li>State "DONE" <span class="timestamp-wrapper"> <span class="timestamp">2011-03-02 Wed 16:42</span></span>
  see <a href="#MountService">@MountService</a>
  see <a href="#secure_container">@secure<sub>container</sub></a>
</li>
</ul>

<p>MediaContainerService is mainly used by app with `system' uid to access sdcard,
because `system' process can't access sdcard, because:
</p>



<pre class="src src-fundamental">$ ls sdcard
d---rwxr-x system sdcard_rw 2010-07-26 12:56 sdcard
</pre>


<blockquote>


<p>
<a href="http://stackoverflow.com/questions/5617797/android-shared-user-id-and-reading-writing-a-file">http://stackoverflow.com/questions/5617797/android-shared-user-id-and-reading-writing-a-file</a>
</p>
<p>
The system user can not access the SD card, because if the SD card gets
unmounted it may need to kill any processes that have files open on it and we
don't want system processes being killed like that. If you want to access the SD
card, you need to not use the system shared user ID.
</p>

</blockquote>


</div>

</div>

<div id="outline-container-1-3-2-4" class="outline-5">
<h5 id="sec-1-3-2-4"><span class="section-number-5">1.3.2.4</span> calling stack</h5>
<div class="outline-text-5" id="text-1-3-2-4">

</div>
</div>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Replace Package</h3>
<div class="outline-text-3" id="text-1-4">

</div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> Uninstall package</h3>
<div class="outline-text-3" id="text-1-5">


</div>

<div id="outline-container-1-5-1" class="outline-4">
<h4 id="sec-1-5-1"><span class="section-number-4">1.5.1</span> Intent.ACTION<sub>PACKAGE</sub><sub>REMOVED</sub></h4>
<div class="outline-text-4" id="text-1-5-1">

</div>
</div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> resolveActivity</h3>
<div class="outline-text-3" id="text-1-6">

<p>as shown in <a href="#IntentFilter-matching">IntentFilter matching</a>, startActivity will call
PM.resolveIntent to resolve the intent, and get one best ResolveInfo;
</p>
<p>
PM.resolveActivity() will also call PM.resolveIntent() to resolve the
intent, but there is ONE difference, PM.resolveActivity will not force
the DEFAULT<sub>ONLY</sub> flag set when calling resolveIntent(). but
startActivity will.
</p>
</div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> android package vs. java package vs. android application</h3>
<div class="outline-text-3" id="text-1-7">

</div>

</div>

<div id="outline-container-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> UID &amp; GID</h3>
<div class="outline-text-3" id="text-1-8">

<p>see also <a href="#Java-Process-Creation">Java Process Creation</a>, <a href="#Zygote">Zygote</a>, <a href="#System-Init">System Init</a> to distinguish
`process uid' against `file uid'
</p>
<p>
UID (including sharedUserId) is maintained by pm.Settings
</p>

</div>

<div id="outline-container-1-8-1" class="outline-4">
<h4 id="sec-1-8-1"><span class="section-number-4">1.8.1</span> pre-defined UID</h4>
<div class="outline-text-4" id="text-1-8-1">

<p>see system/core/include/private/android<sub>filesystem</sub><sub>config</sub>.h
</p>



<pre class="src src-c"><span style="color: #859900;">static</span> <span style="color: #859900;">const</span> <span style="color: #859900;">struct</span> <span style="color: #b58900;">android_id_info</span> <span style="color: #268bd2;">android_ids</span>[] = {
    { <span style="color: #2aa198;">"root"</span>,      AID_ROOT, },
    { <span style="color: #2aa198;">"system"</span>,    AID_SYSTEM, },
    { <span style="color: #2aa198;">"radio"</span>,     AID_RADIO, },
    { <span style="color: #2aa198;">"bluetooth"</span>, AID_BLUETOOTH, },
    { <span style="color: #2aa198;">"graphics"</span>,  AID_GRAPHICS, },
    { <span style="color: #2aa198;">"input"</span>,     AID_INPUT, },
    { <span style="color: #2aa198;">"audio"</span>,     AID_AUDIO, },
    { <span style="color: #2aa198;">"camera"</span>,    AID_CAMERA, },
    { <span style="color: #2aa198;">"log"</span>,       AID_LOG, },
    { <span style="color: #2aa198;">"mount"</span>,     AID_MOUNT, },
    { <span style="color: #2aa198;">"wifi"</span>,      AID_WIFI, },
    { <span style="color: #2aa198;">"dhcp"</span>,      AID_DHCP, },
    { <span style="color: #2aa198;">"adb"</span>,       AID_ADB, },
    { <span style="color: #2aa198;">"install"</span>,   AID_INSTALL, },
    { <span style="color: #2aa198;">"media"</span>,     AID_MEDIA, },
    { <span style="color: #2aa198;">"sdcard_r"</span>,  AID_SDCARD_R, },
    { <span style="color: #2aa198;">"sdcard_rw"</span>, AID_SDCARD_RW, },
    { <span style="color: #2aa198;">"media_rw"</span>,  AID_MEDIA_RW, },
    <span style="color: #586e75; font-style: italic;">// </span><span style="color: #586e75; font-style: italic;">...</span>
    { <span style="color: #2aa198;">"vpn"</span>,       AID_VPN, },
    { <span style="color: #2aa198;">"keystore"</span>,  AID_KEYSTORE, },
    { <span style="color: #2aa198;">"usb"</span>,       AID_USB, },
    { <span style="color: #2aa198;">"mtp"</span>,       AID_MTP, },
    { <span style="color: #2aa198;">"gps"</span>,       AID_GPS, },
    { <span style="color: #2aa198;">"inet"</span>,      AID_INET, },
    { <span style="color: #2aa198;">"net_raw"</span>,   AID_NET_RAW, },
    { <span style="color: #2aa198;">"net_admin"</span>, AID_NET_ADMIN, },
    { <span style="color: #2aa198;">"net_bw_stats"</span>, AID_NET_BW_STATS, },
    { <span style="color: #2aa198;">"net_bw_acct"</span>, AID_NET_BW_ACCT, },
    { <span style="color: #2aa198;">"misc"</span>,      AID_MISC, },
    { <span style="color: #2aa198;">"nobody"</span>,    AID_NOBODY, },
};
</pre>


</div>

</div>

<div id="outline-container-1-8-2" class="outline-4">
<h4 id="sec-1-8-2"><span class="section-number-4">1.8.2</span> app UID</h4>
<div class="outline-text-4" id="text-1-8-2">

<p>during scanPackageLI, but before mInstaller.install(), app UID is
generate by the mSettings.
</p>


<pre class="src src-text">scanPackageLI
  // Just create the setting, don't add it yet. For already existing packages
  // the PkgSetting exists already and doesn't have to be created.
  pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,
                    destResourceFile, pkg.applicationInfo.nativeLibraryDir,
                    pkg.applicationInfo.flags, true, false);
    p.appId = newUserIdLPw(p);
      final int N = mUserIds.size();
        for (int i = 0; i &lt; N; i++) {
            if (mUserIds.get(i) == null) {
                mUserIds.set(i, obj);
                return Process.FIRST_APPLICATION_UID + i;
            }
        }
        // None left?
        if (N &gt; (Process.LAST_APPLICATION_UID-Process.FIRST_APPLICATION_UID)) {
            return -1;
        }
        mUserIds.add(obj);
        return Process.FIRST_APPLICATION_UID + N;
  pkg.applicationInfo.uid = pkgSetting.appId;
</pre>

</div>

</div>

<div id="outline-container-1-8-3" class="outline-4">
<h4 id="sec-1-8-3"><span class="section-number-4">1.8.3</span> sharedUserId</h4>
<div class="outline-text-4" id="text-1-8-3">


</div>

<div id="outline-container-1-8-3-1" class="outline-5">
<h5 id="sec-1-8-3-1"><span class="section-number-5">1.8.3.1</span> sharedUserId pre-defined by the PMS</h5>
<div class="outline-text-5" id="text-1-8-3-1">




<pre class="src src-java">PackageManagerService.&lt;init&gt;
  mSettings.addSharedUserLPw(<span style="color: #2aa198;">"android.uid.system"</span>, <span style="color: #2aa198;">Process</span>.SYSTEM_UID, <span style="color: #2aa198;">ApplicationInfo</span>.FLAG_SYSTEM);
  mSettings.addSharedUserLPw(<span style="color: #2aa198;">"android.uid.phone"</span>, RADIO_UID, <span style="color: #2aa198;">ApplicationInfo</span>.FLAG_SYSTEM);
  mSettings.addSharedUserLPw(<span style="color: #2aa198;">"android.uid.log"</span>, LOG_UID, <span style="color: #2aa198;">ApplicationInfo</span>.FLAG_SYSTEM);
  mSettings.addSharedUserLPw(<span style="color: #2aa198;">"android.uid.nfc"</span>, NFC_UID, <span style="color: #2aa198;">ApplicationInfo</span>.FLAG_SYSTEM);
</pre>


<p>
That is, 
</p><ul>
<li>android.uid.system
</li>
<li>android.uid.phone
</li>
<li>android.uid.log
</li>
<li>android.uid.nfc
</li>
</ul>


<p>
these 4 sharedUserId is defined statically in PMS, and they
  corresponds to the static UID (SYSTEM<sub>UID</sub>, RADIO<sub>UID</sub>, &hellip;)
</p>
</div>

</div>

<div id="outline-container-1-8-3-2" class="outline-5">
<h5 id="sec-1-8-3-2"><span class="section-number-5">1.8.3.2</span> sharedUserId defined by app</h5>
<div class="outline-text-5" id="text-1-8-3-2">

<p>App can define `sharedUserId' freely, PMS will use `Setings' to
maintain the dynamic `sharedUserId' -&gt; `uid' mapping during `scanPackageLI'
</p>
<p>
The most well-known app `sharedUserId' is `android.uid.shared', which
is defined by `Contacts' and `ContactsProvider'
</p>



</div>
</div>
</div>

</div>

<div id="outline-container-1-9" class="outline-3">
<h3 id="sec-1-9"><span class="section-number-3">1.9</span> Multi-User support</h3>
<div class="outline-text-3" id="text-1-9">

<p>android 4.1 use UserManager to support multi-user, in-short, uid
stored in pm.Setting is encoded as a mixer of multi-user-id and app<sub>id</sub>,
e.g. u0<sub>a33</sub>, or u1<sub>a33</sub>. 
</p>
<p>
As against android pre 4.1, app<sub>id</sub> is taken as uid.
</p></div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-05-17T12:29+0800</p>
<p class="author">Author: sunway</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.1 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 23</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
